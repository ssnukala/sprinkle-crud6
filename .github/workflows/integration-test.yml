name: sprinkle-crud6 Integration Test

# AUTO-GENERATED from integration-test-config.json
# To regenerate: node .github/testing-framework/scripts/generate-workflow.js

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  SPRINKLE_DIR: sprinkle-crud6
  COMPOSER_PACKAGE: ssnukala/sprinkle-crud6
  NPM_PACKAGE: "@ssnukala/sprinkle-crud6"
  SCHEMA_PATH: "examples/schema"
  FRAMEWORK_REPO: ssnukala/sprinkle-crud6
  FRAMEWORK_BRANCH: main
  UF_VERSION: "^6.0-beta"
  PHP_VERSION: "8.1"
  NODE_VERSION: "20"

jobs:
  integration-test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: userfrosting_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - name: Checkout sprinkle
        uses: actions/checkout@v4
        with:
          path: ${{ env.SPRINKLE_DIR }}
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, gd, pdo_mysql
          coverage: none
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install testing framework
        run: |
          cd ${{ env.SPRINKLE_DIR }}
          
          if [ -d ".github/crud6-framework" ]; then
            echo "‚úÖ Using local framework"
          else
            echo "üì¶ Installing framework..."
            git clone --depth 1 --branch ${{ env.FRAMEWORK_BRANCH }} \
              https://github.com/${{ env.FRAMEWORK_REPO }}.git /tmp/crud6-repo
            mkdir -p .github/crud6-framework
            cp -r /tmp/crud6-repo/.github/testing-framework/* .github/crud6-framework/
            chmod +x .github/crud6-framework/scripts/*.php
            echo "‚úÖ Framework installed"
          fi
          
          mkdir -p .github/config
          if [ -d "/tmp/crud6-repo/.github/config" ]; then
            cp /tmp/crud6-repo/.github/config/integration-test-*.json .github/config/ 2>/dev/null || true
          fi
      
      - name: Create UserFrosting project
        run: |
          composer create-project userfrosting/userfrosting userfrosting "${{ env.UF_VERSION }}" \
            --no-scripts --no-install --ignore-platform-reqs
          
          cd userfrosting/app
          mkdir -p storage/sessions storage/cache storage/logs logs cache sessions
          chmod -R 777 storage sessions logs cache
          touch logs/userfrosting.log
      
      - name: Configure Composer dependencies
        run: |
          cd userfrosting
          
          if [ -d "/tmp/crud6-repo" ]; then
            composer config repositories.crud6 path /tmp/crud6-repo
            composer require ssnukala/sprinkle-crud6:@dev --no-update
          fi
          
          composer config repositories.local path ../${{ env.SPRINKLE_DIR }}
          composer require ${{ env.COMPOSER_PACKAGE }}:@dev --no-update
          
          composer config minimum-stability beta
          composer config prefer-stable true
          
          composer install --no-interaction --prefer-dist
      
      - name: Configure NPM dependencies
        run: |
          cd userfrosting
          npm update
          
          if [ -d "/tmp/crud6-repo" ]; then
            cd /tmp/crud6-repo
            npm pack
            mv ssnukala-sprinkle-crud6-*.tgz "$GITHUB_WORKSPACE/userfrosting/"
            cd "$GITHUB_WORKSPACE/userfrosting"
            npm install ./ssnukala-sprinkle-crud6-*.tgz
          fi
          
          cd "$GITHUB_WORKSPACE/${{ env.SPRINKLE_DIR }}"
          npm pack 2>/dev/null || true
          if ls *.tgz 1> /dev/null 2>&1; then
            mv *.tgz "$GITHUB_WORKSPACE/userfrosting/"
            cd "$GITHUB_WORKSPACE/userfrosting"
            npm install ./*.tgz 2>/dev/null || echo "NPM package optional"
          fi
      
      - name: Configure MyApp.php
        run: |
          cd userfrosting
          
          sed -i '/use UserFrosting\\Sprinkle\\Core\\Core;/a use UserFrosting\\Sprinkle\\CRUD6\\CRUD6;' app/src/MyApp.php
          sed -i '/Admin::class,/a \            CRUD6::class,' app/src/MyApp.php
      
      - name: Configure main.ts
        run: |
          cd userfrosting
          
          sed -i "/import AdminSprinkle from '@userfrosting\\/sprinkle-admin'/a import CRUD6Sprinkle from '@ssnukala\\/sprinkle-crud6'" app/assets/main.ts
          sed -i "/app.use(AdminSprinkle)/a app.use(CRUD6Sprinkle)" app/assets/main.ts
      
      - name: Configure routes (simple pattern)
        run: |
          cd userfrosting
          
          # Simple array spread pattern
          sed -i "/import AdminRoutes from '@userfrosting\\/sprinkle-admin\\/routes'/a import CRUD6Routes from '@ssnukala/sprinkle-crud6/routes'" app/assets/router/index.ts
          sed -i '/\\.\\.\\.AccountRoutes,/a \\            ...CRUD6Routes,' app/assets/router/index.ts

      
      - name: Configure vite.config.ts
        run: |
          cd userfrosting
          
          if grep -q "optimizeDeps:" vite.config.ts; then
            if grep -q "include:" vite.config.ts; then
              sed -i "/include: \\[/a \\            \'limax\', \'lodash.deburr\'," vite.config.ts
            else
              sed -i "/optimizeDeps: {/a \\        include: [\'limax\', \'lodash.deburr\']," vite.config.ts
            fi
          else
            sed -i "/plugins: \\[/,/\\],/a \\    optimizeDeps: {\\n        include: [\'limax\', \'lodash.deburr\']\\n    }," vite.config.ts
          fi

      
      - name: Setup environment
        run: |
          cd userfrosting
          cp app/.env.example app/.env
          sed -i 's/DB_CONNECTION=.*/DB_CONNECTION="mysql"/' app/.env
          sed -i 's/DB_HOST=.*/DB_HOST="127.0.0.1"/' app/.env
          sed -i 's/DB_PORT=.*/DB_PORT="3306"/' app/.env
          sed -i 's/DB_NAME=.*/DB_NAME="userfrosting_test"/' app/.env
          sed -i 's/DB_USER=.*/DB_USER="root"/' app/.env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD="root"/' app/.env
          echo "BAKERY_CONFIRM_SENSITIVE_COMMAND=false" >> app/.env
          echo "TEST_SESSION_HANDLER=database" >> app/.env
      
      - name: Run migrations
        run: |
          cd userfrosting
          php bakery migrate --force
      
      - name: Generate and load SQL seed data
        run: |
          cd userfrosting
          
          SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/${{ env.SCHEMA_PATH }}"
          if [ -z "${{ env.SCHEMA_PATH }}" ]; then
            SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/app/schema/crud6"
          fi
          
          if [ ! -d "$SCHEMA_DIR" ]; then
            echo "‚ùå ERROR: Schema directory not found: $SCHEMA_DIR"
            exit 1
          fi
          
          echo "‚úÖ Using schemas from: $SCHEMA_DIR"
          
          node ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/generate-seed-sql.js \
            "$SCHEMA_DIR" seed-data.sql
          
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/load-seed-sql.php \
            seed-data.sql
          
          echo "‚úÖ Schema-driven SQL loaded"

      - name: Run PHP seeds
        run: |
          cd userfrosting
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/run-seeds.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-seeds.json
      
      - name: Validate seed data
        run: |
          cd userfrosting
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/check-seeds-modular.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-seeds.json
      
      - name: Test seed idempotency
        run: |
          cd userfrosting
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-seed-idempotency-modular.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-seeds.json

      - name: Verify runtime directories
        run: |
          cd userfrosting
          
          echo "========================================="
          echo "Verifying Runtime Directories"
          echo "========================================="
          
          # Ensure all runtime directories exist with proper permissions
          mkdir -p app/storage/sessions app/storage/cache app/storage/logs
          mkdir -p app/logs app/cache app/sessions
          chmod -R 777 app/storage app/logs app/cache app/sessions
          
          # Verify directories are writable
          for dir in app/storage/sessions app/storage/cache app/storage/logs app/logs app/cache app/sessions; do
            if [ -w "$dir" ]; then
              echo "‚úÖ $dir is writable"
            else
              echo "‚ùå $dir is NOT writable"
              exit 1
            fi
          done
          
          echo "‚úÖ All runtime directories verified and writable"

      - name: Install Playwright
        run: |
          cd userfrosting
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Build frontend assets
        run: |
          cd userfrosting
          # UserFrosting 6 uses npm run uf-bundle to build assets via Vite
          # Note: Even though we build, we still need vite dev server for proper asset serving
          npm run uf-bundle || echo "‚ö†Ô∏è Build failed but continuing with tests"
      
      - name: Start PHP development server
        run: |
          cd userfrosting
          # Start PHP server using bakery serve in background
          php bakery serve &
          SERVER_PID=$!
          echo $SERVER_PID > /tmp/server.pid
          sleep 10
          
          # Test if server is running
          curl -f http://localhost:8080 || (echo "‚ö†Ô∏è Server may not be ready yet" && sleep 5 && curl -f http://localhost:8080)
          echo "‚úÖ PHP server started on localhost:8080"
      
      - name: Start Vite development server
        run: |
          cd userfrosting
          # Use npm update to fix any package issues
          npm update
          # Start Vite server in background using bakery command (follows UF6 standards)
          php bakery assets:vite &
          VITE_PID=$!
          echo $VITE_PID > /tmp/vite.pid
          
          # Wait longer for Vite to fully start up
          echo "Waiting for Vite server to start..."
          sleep 20
          
          # Try to verify Vite is running by checking if the page loads properly
          echo "Testing if frontend is accessible..."
          curl -f http://localhost:8080 || echo "‚ö†Ô∏è Page load test after Vite start"
          
          echo "‚úÖ Vite server started"
      
      - name: Test API and frontend paths
        run: |
          cd userfrosting
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-paths.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-paths.json

      - name: Capture screenshots
        run: |
          cd userfrosting
          node ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/take-screenshots-modular.js \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-paths.json \
            screenshots

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-screenshots
          path: userfrosting/screenshots/
          retention-days: 7
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: userfrosting/app/logs/
          retention-days: 7
      
      - name: Stop servers
        if: always()
        run: |
          if [ -f /tmp/server.pid ]; then
            kill $(cat /tmp/server.pid) || true
          fi
          if [ -f /tmp/vite.pid ]; then
            kill $(cat /tmp/vite.pid) || true
          fi
