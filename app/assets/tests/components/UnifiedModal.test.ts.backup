/**
 * UnifiedModal Component Tests
 * 
 * Tests for the UnifiedModal component - flexible modal for CRUD operations
 * Uses dynamic schema-based data from centralized test fixtures
 */

import { describe, it, expect, vi, beforeEach } from 'vitest'
import { mount } from '@vue/test-utils'
import { createPinia, setActivePinia } from 'pinia'
import UnifiedModal from '../../components/CRUD6/UnifiedModal.vue'
import type { ActionConfig } from '../../composables/useCRUD6Actions'
import { loadSchemaFixture, loadSingleRecordFixture } from '../fixtures'

// Mock UIkit
vi.mock('uikit', () => ({
  default: {
    modal: vi.fn(() => ({
      show: vi.fn(),
      hide: vi.fn()
    }))
  }
}))

// Mock CRUD6Form
const CRUD6Form = {
  name: 'CRUD6Form',
  template: '<div class="mock-crud6-form"><slot /></div>',
  props: ['crud6', 'model', 'schema'],
  emits: ['success']
}

describe('UnifiedModal.vue', () => {
  // Load dynamic schema and data
  const usersSchema = loadSchemaFixture('users')
  const productsSchema = loadSchemaFixture('products')
  const userRecord = loadSingleRecordFixture('users')
  
  beforeEach(() => {
    setActivePinia(createPinia())
  })

  it('renders with basic action config', () => {
    const action: ActionConfig = {
      key: 'delete',
      label: 'Delete Record',
      type: 'delete',
      confirm: 'Are you sure?'
    }

    const wrapper = mount(UnifiedModal, {
      props: {
        action
      },
      global: {
        components: {
          CRUD6Form
        },
        mocks: {
          $t: (key: string) => key
        }
      }
    })

    expect(wrapper.exists()).toBe(true)
  })

  it('renders confirmation message', () => {
    const action: ActionConfig = {
      key: 'archive',
      label: 'Archive',
      type: 'action',
      confirm: 'Archive this record?'
    }

    const wrapper = mount(UnifiedModal, {
      props: {
        action
      },
      global: {
        components: {
          CRUD6Form
        },
        mocks: {
          $t: (key: string) => key
        }
      }
    })

    expect(wrapper.html()).toContain('Archive this record?')
  })

  it('emits confirmed event on confirmation', async () => {
    const action: ActionConfig = {
      key: 'delete_user',
      label: 'Delete User',
      type: 'delete',
      confirm: 'Delete this user?'
    }

    const wrapper = mount(UnifiedModal, {
      props: {
        action,
        record: userRecord
      },
      global: {
        components: {
          CRUD6Form
        },
        mocks: {
          $t: (key: string) => key
        }
      }
    })

    await wrapper.vm.$nextTick()
    
    // Find confirm button using data-test attribute
    // For delete type with 'yes_no' buttons, confirm button has action='confirm'
    const confirmButton = wrapper.find('[data-test="btn-confirm-delete_user"]')
    expect(confirmButton.exists()).toBe(true)
    
    await confirmButton.trigger('click')
    expect(wrapper.emitted()).toHaveProperty('confirmed')
  })

  it('emits cancelled event on cancellation', async () => {
    const action: ActionConfig = {
      key: 'delete',
      label: 'Delete',
      type: 'delete',
      confirm: 'Delete?'
    }

    const wrapper = mount(UnifiedModal, {
      props: {
        action
      },
      global: {
        components: {
          CRUD6Form
        },
        mocks: {
          $t: (key: string) => key
        }
      }
    })

    // Find and click cancel button
    const buttons = wrapper.findAll('button')
    if (buttons.length > 1) {
      // Usually the second button is cancel
      await buttons[1].trigger('click')
      expect(wrapper.emitted()).toHaveProperty('cancelled')
    }
  })

  it('renders with record data for interpolation', () => {
    const action: ActionConfig = {
      key: 'delete_user',
      label: 'Delete User',
      type: 'delete',
      confirm: 'Delete user {{user_name}}?'
    }

    // Use dynamic user data from schema
    const wrapper = mount(UnifiedModal, {
      props: {
        action,
        record: userRecord
      },
      global: {
        components: {
          CRUD6Form
        },
        mocks: {
          $t: (key: string) => key
        }
      }
    })

    // Should interpolate user_name from userRecord
    expect(wrapper.html()).toContain(`Delete user ${userRecord.user_name}?`)
  })

  it('renders form type with CRUD6Form component', async () => {
    const action: ActionConfig = {
      key: 'edit_product',
      label: 'Edit Product',
      type: 'form'
    }

    // Use dynamic products schema
    const wrapper = mount(UnifiedModal, {
      props: {
        action,
        model: 'products',
        schema: productsSchema
      },
      global: {
        components: {
          CRUD6Form
        },
        mocks: {
          $t: (key: string) => key
        }
      }
    })

    await wrapper.vm.$nextTick()
    
    // Form type should render CRUD6Form component
    const formComponent = wrapper.findComponent(CRUD6Form)
    expect(formComponent.exists()).toBe(true)
    expect(formComponent.props('model')).toBe('products')
    expect(formComponent.props('schema')).toBeDefined()
  })
  })

  it('renders input fields when configured', async () => {
    // Use actual field from users schema
    const action: ActionConfig = {
      key: 'update_email',
      label: 'Update Email',
      type: 'action',
      confirm: 'Enter new email address',
      modal_config: {
        type: 'input',
        fields: ['email']
      }
    }

    // Pass users schema fields
    const wrapper = mount(UnifiedModal, {
      props: {
        action,
        schemaFields: usersSchema.fields,
        model: 'users'
      },
      global: {
        components: {
          CRUD6Form
        },
        mocks: {
          $t: (key: string) => key
        }
      }
    })

    await wrapper.vm.$nextTick()
    
    // Should render input field for email from schema
    const emailInput = wrapper.find('input[name="email"]')
    expect(emailInput.exists()).toBe(true)
  })

  it('handles multiple input fields', async () => {
    // Use actual fields from users schema
    const action: ActionConfig = {
      key: 'update_name',
      label: 'Update Name',
      type: 'action',
      confirm: 'Enter your name',
      modal_config: {
        type: 'input',
        fields: ['first_name', 'last_name']
      }
    }

    // Pass users schema fields
    const wrapper = mount(UnifiedModal, {
      props: {
        action,
        schemaFields: usersSchema.fields,
        model: 'users'
      },
      global: {
        components: {
          CRUD6Form
        },
        mocks: {
          $t: (key: string) => key
        }
      }
    })

    await wrapper.vm.$nextTick()
    
    // Should render both input fields from schema
    expect(wrapper.find('input[name="first_name"]').exists()).toBe(true)
    expect(wrapper.find('input[name="last_name"]').exists()).toBe(true)
  })

  it('passes schema to CRUD6Form for edit mode', async () => {
    const action: ActionConfig = {
      key: 'edit_product',
      label: 'Edit Product',
      type: 'form'
    }

    // Use dynamic product data (would come from loadSingleRecordFixture if products had test data)
    const productRecord = {
      id: 1,
      name: 'Test Product',
      sku: 'TEST-001'
    }

    const wrapper = mount(UnifiedModal, {
      props: {
        action,
        model: 'products',
        schema: productsSchema,
        record: productRecord
      },
      global: {
        components: {
          CRUD6Form
        },
        mocks: {
          $t: (key: string) => key
        }
      }
    })

    await wrapper.vm.$nextTick()
    
    const formComponent = wrapper.findComponent(CRUD6Form)
    expect(formComponent.exists()).toBe(true)
    expect(formComponent.props('schema')).toBeDefined()
    expect(formComponent.props('schema')).toEqual(productsSchema)
    expect(formComponent.props('crud6')).toEqual(productRecord)
  })
})
