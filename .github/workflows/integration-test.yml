name: Integration Test with UserFrosting 6

# This is the CRUD6 sprinkle's own integration test
# It uses the testing framework that we provide to other sprinkles
# This demonstrates "eating our own dog food" - using the framework ourselves

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  # CRUD6 sprinkle configuration
  SPRINKLE_DIR: sprinkle-crud6
  COMPOSER_PACKAGE: ssnukala/sprinkle-crud6
  NPM_PACKAGE: @ssnukala/sprinkle-crud6
  
  # CRUD6 uses example schemas (not app/schema/crud6/)
  SCHEMA_PATH: "examples/schema"
  
  # Framework is local (we ARE the framework!)
  FRAMEWORK_LOCAL: true

jobs:
  integration-test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: userfrosting_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      # ========================================================================
      # Checkout CRUD6 Sprinkle
      # ========================================================================
      - name: Checkout sprinkle-crud6
        uses: actions/checkout@v4
        with:
          path: sprinkle-crud6
      
      # ========================================================================
      # Setup PHP and Node.js
      # ========================================================================
      - name: Setup PHP 8.1
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.1"
          extensions: mbstring, xml, gd, pdo_mysql
          coverage: none
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      
      # ========================================================================
      # Framework is Local (we are testing the framework itself)
      # ========================================================================
      - name: Use local testing framework
        run: |
          cd sprinkle-crud6
          
          echo "========================================="
          echo "CRUD6 Testing Framework (Local)"
          echo "========================================="
          echo ""
          echo "‚úÖ Framework is local - we ARE the framework!"
          echo ""
          echo "Framework location: .github/testing-framework/"
          ls -la .github/testing-framework/
          echo ""
          echo "Available scripts:"
          ls -1 .github/scripts/
          echo ""
          echo "========================================="
      
      # ========================================================================
      # Use CRUD6 Test Configuration
      # ========================================================================
      - name: Verify test configuration
        run: |
          cd sprinkle-crud6
          
          echo "========================================="
          echo "CRUD6 Test Configuration"
          echo "========================================="
          echo ""
          echo "Using CRUD6's own test configuration:"
          echo "  - .github/config/integration-test-paths.json"
          echo "  - .github/config/integration-test-seeds.json"
          echo ""
          
          if [ -f ".github/config/integration-test-paths.json" ] && [ -f ".github/config/integration-test-seeds.json" ]; then
            echo "‚úÖ Test configuration files found"
          else
            echo "‚ùå ERROR: Test configuration files missing"
            exit 1
          fi
      
      # ========================================================================
      # Create UserFrosting Project
      # ========================================================================
      - name: Create UserFrosting project
        run: |
          composer create-project userfrosting/userfrosting userfrosting "^6.0-beta" \
            --no-scripts --no-install --ignore-platform-reqs
          
          # Create runtime directories
          cd userfrosting/app
          mkdir -p storage/sessions storage/cache storage/logs logs cache sessions
          chmod -R 777 storage sessions logs cache
          touch logs/userfrosting.log
      
      # ========================================================================
      # Configure Composer - Install CRUD6
      # ========================================================================
      - name: Configure Composer
        run: |
          cd userfrosting
          
          # Add CRUD6 from local path
          composer config repositories.local path ../sprinkle-crud6
          composer require ssnukala/sprinkle-crud6:@dev --no-update
          
          # Configure for beta packages
          composer config minimum-stability beta
          composer config prefer-stable true
      
      - name: Install PHP dependencies
        run: |
          cd userfrosting
          composer install --no-interaction --prefer-dist
      
      # ========================================================================
      # Configure NPM - Install CRUD6
      # ========================================================================
      - name: Package and install NPM
        run: |
          cd sprinkle-crud6
          npm pack
          mv ssnukala-sprinkle-crud6-*.tgz ../userfrosting/
          
          cd ../userfrosting
          npm update
          npm install ./ssnukala-sprinkle-crud6-*.tgz
      
      # ========================================================================
      # Configure UserFrosting App
      # ========================================================================
      - name: Configure MyApp.php
        run: |
          cd userfrosting
          
          # Add CRUD6 sprinkle
          sed -i '/use UserFrosting\\Sprinkle\\Core\\Core;/a use UserFrosting\\Sprinkle\\CRUD6\\CRUD6;' app/src/MyApp.php
          sed -i '/Admin::class,/a \            CRUD6::class,' app/src/MyApp.php
          
          echo "MyApp.php configured with CRUD6"
          cat app/src/MyApp.php
      
      # ========================================================================
      # Configure Frontend (CRUD6 Routes)
      # ========================================================================
      - name: Configure router/index.ts for CRUD6
        run: |
          cd userfrosting
          
          # Add CRUD6 routes (simple pattern)
          sed -i "/import AdminRoutes from '@userfrosting\/sprinkle-admin\/routes'/a import CRUD6Routes from '@ssnukala\/sprinkle-crud6\/routes'" app/assets/router/index.ts
          sed -i '/\.\.\.AccountRoutes,/a \            ...CRUD6Routes,' app/assets/router/index.ts
          
          cat app/assets/router/index.ts
      
      - name: Configure main.ts for CRUD6
        run: |
          cd userfrosting
          
          # Add CRUD6 sprinkle
          sed -i "/import AdminSprinkle from '@userfrosting\/sprinkle-admin'/a import CRUD6Sprinkle from '@ssnukala\/sprinkle-crud6'" app/assets/main.ts
          sed -i "/app.use(AdminSprinkle)/a app.use(CRUD6Sprinkle)" app/assets/main.ts
          
          cat app/assets/main.ts
      
      - name: Configure vite.config.ts for CRUD6 dependencies
        run: |
          cd userfrosting
          
          # CRUD6 uses limax which requires special Vite configuration
          if grep -q "optimizeDeps:" vite.config.ts; then
            if grep -q "include:" vite.config.ts; then
              sed -i "/include: \[/a \            'limax',\n            'lodash.deburr'," vite.config.ts
            else
              sed -i "/optimizeDeps: {/a \        include: ['limax', 'lodash.deburr']," vite.config.ts
            fi
          else
            echo "Creating optimizeDeps section..."
            sed -i "/plugins: \[/,/\],/a \    optimizeDeps: {\n        include: ['limax', 'lodash.deburr']\n    }," vite.config.ts
          fi
          
          echo "vite.config.ts configured:"
          cat vite.config.ts
      
      # ========================================================================
      # Setup Environment
      # ========================================================================
      - name: Setup environment
        run: |
          cd userfrosting
          cp app/.env.example app/.env
          sed -i 's/DB_CONNECTION=.*/DB_CONNECTION="mysql"/' app/.env
          sed -i 's/DB_HOST=.*/DB_HOST="127.0.0.1"/' app/.env
          sed -i 's/DB_PORT=.*/DB_PORT="3306"/' app/.env
          sed -i 's/DB_NAME=.*/DB_NAME="userfrosting_test"/' app/.env
          sed -i 's/DB_USER=.*/DB_USER="root"/' app/.env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD="root"/' app/.env
          echo "BAKERY_CONFIRM_SENSITIVE_COMMAND=false" >> app/.env
          echo "TEST_SESSION_HANDLER=database" >> app/.env
      
      # ========================================================================
      # Run Migrations
      # ========================================================================
      - name: Run migrations
        run: |
          cd userfrosting
          php bakery migrate --force
      
      # ========================================================================
      # Generate SQL Seed Data from Schemas (Using Framework)
      # ========================================================================
      - name: Generate SQL seed data from schemas
        run: |
          cd userfrosting
          
          echo "========================================="
          echo "Generating SQL Seed Data from Schemas"
          echo "========================================="
          echo ""
          
          # CRUD6 uses examples/schema
          SCHEMA_DIR="../sprinkle-crud6/${{ env.SCHEMA_PATH }}"
          
          echo "Schema directory: ${{ env.SCHEMA_PATH }}"
          echo "Full path: $SCHEMA_DIR"
          echo ""
          
          # Verify schemas exist
          if [ ! -d "$SCHEMA_DIR" ]; then
            echo "‚ùå ERROR: Schema directory not found: $SCHEMA_DIR"
            exit 1
          fi
          
          SCHEMA_COUNT=$(ls -1 $SCHEMA_DIR/*.json 2>/dev/null | wc -l)
          echo "‚úÖ Found $SCHEMA_COUNT schema file(s):"
          ls -1 $SCHEMA_DIR/*.json
          echo ""
          
          # Create output directory
          mkdir -p app/sql/seeds
          
          # Use framework script (local)
          cp ../sprinkle-crud6/.github/scripts/generate-seed-sql.js .
          
          # Generate SQL from schemas
          echo "Generating SQL seed data from CRUD6 schemas..."
          node generate-seed-sql.js $SCHEMA_DIR app/sql/seeds/crud6-test-data.sql
          
          echo ""
          echo "‚úÖ Generated SQL seed data:"
          ls -lh app/sql/seeds/crud6-test-data.sql
          
          # Show preview
          echo ""
          echo "Preview (first 15 lines):"
          head -15 app/sql/seeds/crud6-test-data.sql
      
      # ========================================================================
      # Load SQL Seed Data (Using Framework)
      # ========================================================================
      - name: Load SQL seed data
        run: |
          cd userfrosting
          
          echo "========================================="
          echo "Loading SQL Seed Data"
          echo "========================================="
          echo ""
          
          # Use framework script (local)
          cp ../sprinkle-crud6/.github/scripts/load-seed-sql.php .
          
          # Load SQL into database
          php load-seed-sql.php app/sql/seeds/crud6-test-data.sql
          
          echo ""
          echo "‚úÖ SQL seed data loaded successfully"
      
      # ========================================================================
      # Run CRUD6 Seeds (Using Framework)
      # ========================================================================
      - name: Run CRUD6 seeds
        run: |
          cd userfrosting
          
          # Use framework script (local)
          cp ../sprinkle-crud6/.github/scripts/run-seeds.php .
          cp ../sprinkle-crud6/.github/config/integration-test-seeds.json .
          
          # Run seeds
          php run-seeds.php integration-test-seeds.json
      
      # ========================================================================
      # Validate CRUD6 Seeds (Using Framework)
      # ========================================================================
      - name: Validate CRUD6 seeds
        run: |
          cd userfrosting
          
          cp ../sprinkle-crud6/.github/scripts/check-seeds-modular.php .
          php check-seeds-modular.php integration-test-seeds.json
      
      # ========================================================================
      # Test Seed Idempotency (Using Framework)
      # ========================================================================
      - name: Test seed idempotency
        run: |
          cd userfrosting
          
          cp ../sprinkle-crud6/.github/scripts/test-seed-idempotency-modular.php .
          
          BEFORE=$(php test-seed-idempotency-modular.php integration-test-seeds.json | grep "BEFORE:")
          php run-seeds.php integration-test-seeds.json
          php test-seed-idempotency-modular.php integration-test-seeds.json after "$BEFORE"
      
      # ========================================================================
      # Create Admin User
      # ========================================================================
      - name: Create admin user
        run: |
          cd userfrosting
          php bakery create:admin-user \
            --username=admin \
            --password=admin123 \
            --email=admin@example.com \
            --firstName=Admin \
            --lastName=User
      
      # ========================================================================
      # Build and Start Servers
      # ========================================================================
      - name: Install Playwright
        run: |
          cd userfrosting
          npm install playwright
          npx playwright install chromium --with-deps
      
      - name: Build frontend assets
        run: |
          cd userfrosting
          php bakery bake || echo "‚ö†Ô∏è Build failed but continuing"
      
      - name: Start PHP server
        run: |
          cd userfrosting
          php bakery serve &
          sleep 10
          curl -f http://localhost:8080 || echo "‚ö†Ô∏è Server starting"
      
      - name: Start Vite server
        run: |
          cd userfrosting
          php bakery assets:vite &
          sleep 20
      
      # ========================================================================
      # Test CRUD6 Paths (Using Framework)
      # ========================================================================
      - name: Test CRUD6 API and frontend paths
        run: |
          cd userfrosting
          
          # Use framework script (local)
          cp ../sprinkle-crud6/.github/scripts/test-paths.php .
          cp ../sprinkle-crud6/.github/config/integration-test-paths.json .
          
          # Test all CRUD6 paths
          php test-paths.php integration-test-paths.json
      
      # ========================================================================
      # Capture CRUD6 Screenshots (Using Framework)
      # ========================================================================
      - name: Capture CRUD6 screenshots
        run: |
          cd userfrosting
          
          cp ../sprinkle-crud6/.github/scripts/take-screenshots-modular.js .
          node take-screenshots-modular.js integration-test-paths.json
      
      # ========================================================================
      # Upload Artifacts
      # ========================================================================
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crud6-screenshots
          path: /tmp/screenshot_*.png
          if-no-files-found: ignore
          retention-days: 30
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crud6-logs
          path: |
            userfrosting/app/logs/*.log
            userfrosting/app/storage/logs/*.log
          if-no-files-found: ignore
          retention-days: 30
      
      # ========================================================================
      # Summary
      # ========================================================================
      - name: Summary
        if: always()
        run: |
          echo "========================================="
          echo "CRUD6 Integration Test Complete"
          echo "========================================="
          echo ""
          echo "‚úÖ Used local testing framework"
          echo "‚úÖ Generated SQL from schemas (examples/schema)"
          echo "‚úÖ Loaded SQL seed data"
          echo "‚úÖ Database migrations completed"
          echo "‚úÖ CRUD6 seeds run and validated"
          echo "‚úÖ Seed idempotency verified"
          echo "‚úÖ CRUD6 API and frontend paths tested"
          echo "‚úÖ CRUD6 screenshots captured"
          echo ""
          echo "üì∏ View artifacts:"
          echo "   - crud6-screenshots: Frontend screenshots"
          echo "   - crud6-logs: PHP error logs"
          echo ""
          echo "üéØ This workflow demonstrates:"
          echo "   - CRUD6 eating its own dog food (using the framework we provide)"
          echo "   - All framework features working correctly"
          echo "   - Schema-driven SQL generation"
          echo "   - Complete integration test pipeline"
