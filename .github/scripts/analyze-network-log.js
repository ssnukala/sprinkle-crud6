#!/usr/bin/env node

/**
 * Network Request Analysis Tool
 * 
 * Analyzes the network_requests.json file generated by the integration test
 * to identify redundant API calls and other issues.
 * 
 * Usage: node analyze-network-log.js /path/to/network_requests.json
 */

import { readFileSync } from 'fs';

function analyzeNetworkLog(logPath) {
    console.log('========================================');
    console.log('Network Request Analysis Tool');
    console.log('========================================');
    console.log('');
    
    // Read the log file
    let data;
    try {
        const fileContent = readFileSync(logPath, 'utf-8');
        data = JSON.parse(fileContent);
    } catch (error) {
        console.error('âŒ Error reading log file:', error.message);
        process.exit(1);
    }
    
    console.log(`ðŸ“… Analysis Date: ${data.timestamp}`);
    console.log(`ðŸŒ Base URL: ${data.baseUrl}`);
    console.log('');
    
    // Overall statistics
    const totalRequests = data.summary.totalRequests;
    const totalSchemaApiCalls = data.summary.schemaApiCalls.list + data.summary.schemaApiCalls.detail;
    const totalYamlImports = data.summary.yamlImports.list + data.summary.yamlImports.detail;
    
    console.log('ðŸ“Š Overall Statistics');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log(`Total XHR/Fetch Requests: ${totalRequests}`);
    console.log(`Total Schema API Calls: ${totalSchemaApiCalls}`);
    console.log(`Total YAML Imports: ${totalYamlImports} ${totalYamlImports > 0 ? 'âš ï¸' : 'âœ…'}`);
    console.log('');
    
    // Analyze each page
    analyzePage('Groups List', data.pages.list);
    analyzePage('Group Detail', data.pages.detail);
    
    // Issue detection
    const issues = [];
    
    if (totalSchemaApiCalls > 2) {
        issues.push({
            severity: 'HIGH',
            message: `Too many schema API calls (${totalSchemaApiCalls}) - expected 2 (one per page)`,
            recommendation: 'Check schema caching and component prop passing'
        });
    }
    
    if (totalYamlImports > 0) {
        issues.push({
            severity: 'HIGH',
            message: `YAML files being imported (${totalYamlImports}) - validation adapter not working`,
            recommendation: 'Ensure all components use useCRUD6RegleAdapter instead of useRuleSchemaAdapter'
        });
    }
    
    // Check for duplicate schema calls on same page
    if (data.summary.schemaApiCalls.list > 1) {
        issues.push({
            severity: 'MEDIUM',
            message: `Multiple schema calls on list page (${data.summary.schemaApiCalls.list})`,
            recommendation: 'Child components should receive schema via props instead of loading independently'
        });
    }
    
    if (data.summary.schemaApiCalls.detail > 1) {
        issues.push({
            severity: 'MEDIUM',
            message: `Multiple schema calls on detail page (${data.summary.schemaApiCalls.detail})`,
            recommendation: 'Child components should receive schema via props instead of loading independently'
        });
    }
    
    // Report issues
    if (issues.length > 0) {
        console.log('');
        console.log('âš ï¸  Issues Detected');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        issues.forEach((issue, idx) => {
            console.log('');
            console.log(`${idx + 1}. [${issue.severity}] ${issue.message}`);
            console.log(`   ðŸ’¡ Recommendation: ${issue.recommendation}`);
        });
    } else {
        console.log('');
        console.log('âœ… No Issues Detected');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('All network requests look good!');
    }
    
    console.log('');
    console.log('========================================');
    console.log('Analysis Complete');
    console.log('========================================');
    
    // Exit with error code if high severity issues found
    const highSeverityIssues = issues.filter(i => i.severity === 'HIGH');
    if (highSeverityIssues.length > 0) {
        console.log('');
        console.log(`âš ï¸  Found ${highSeverityIssues.length} high severity issue(s)`);
        process.exit(1);
    }
}

function analyzePage(pageTitle, pageData) {
    console.log(`ðŸ“„ ${pageTitle}`);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log(`URL: ${pageData.url}`);
    console.log(`Total Requests: ${pageData.requests.length}`);
    
    // Categorize requests
    const schemaRequests = pageData.requests.filter(r => r.url.includes('/schema'));
    const yamlRequests = pageData.requests.filter(r => r.url.endsWith('.yaml') || r.url.includes('.yaml?'));
    const apiRequests = pageData.requests.filter(r => r.url.includes('/api/crud6/') && !r.url.includes('/schema'));
    
    console.log('');
    console.log('Request Breakdown:');
    console.log(`  Schema API: ${schemaRequests.length}`);
    if (schemaRequests.length > 0) {
        schemaRequests.forEach(req => {
            const url = new URL(req.url);
            const context = url.searchParams.get('context') || 'full';
            const includeRelated = url.searchParams.get('include_related') || 'false';
            console.log(`    - ${req.method} ${url.pathname}`);
            console.log(`      context=${context}, include_related=${includeRelated}`);
        });
    }
    
    console.log(`  YAML Imports: ${yamlRequests.length} ${yamlRequests.length > 0 ? 'âš ï¸' : 'âœ…'}`);
    if (yamlRequests.length > 0) {
        yamlRequests.forEach(req => {
            const url = new URL(req.url);
            const filename = url.pathname.split('/').pop().split('?')[0];
            console.log(`    - ${filename}`);
        });
    }
    
    console.log(`  CRUD6 API: ${apiRequests.length}`);
    if (apiRequests.length > 0) {
        apiRequests.forEach(req => {
            const url = new URL(req.url);
            console.log(`    - ${req.method} ${url.pathname}`);
        });
    }
    
    console.log('');
}

// Parse command line arguments
const args = process.argv.slice(2);

if (args.length < 1) {
    console.error('Usage: node analyze-network-log.js /path/to/network_requests.json');
    console.error('Example: node analyze-network-log.js /tmp/network_requests.json');
    process.exit(1);
}

const logPath = args[0];

// Run the analysis
analyzeNetworkLog(logPath);
