name: sprinkle-crud6 Integration Test

# AUTO-GENERATED from integration-test-config.json
# To regenerate: node .github/testing-framework/scripts/generate-workflow.js

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  SPRINKLE_DIR: sprinkle-crud6
  COMPOSER_PACKAGE: ssnukala/sprinkle-crud6
  NPM_PACKAGE: "@ssnukala/sprinkle-crud6"
  SCHEMA_PATH: "examples/schema"
  FRAMEWORK_REPO: ssnukala/sprinkle-crud6
  FRAMEWORK_BRANCH: main
  UF_VERSION: "^6.0-beta"
  PHP_VERSION: "8.1"
  NODE_VERSION: "20"

jobs:
  integration-test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: userfrosting_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - name: Checkout sprinkle
        uses: actions/checkout@v4
        with:
          path: ${{ env.SPRINKLE_DIR }}
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, gd, pdo_mysql
          coverage: none
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install testing framework
        run: |
          cd ${{ env.SPRINKLE_DIR }}
          
          # Check if framework already exists (either as crud6-framework or testing-framework)
          if [ -d ".github/crud6-framework" ]; then
            echo "‚úÖ Using local framework (crud6-framework)"
          elif [ -d ".github/testing-framework" ]; then
            echo "‚úÖ Using local framework (testing-framework)"
            # Copy to crud6-framework for consistency (copy vs symlink to allow independent modifications)
            cp -r .github/testing-framework .github/crud6-framework
            chmod +x .github/crud6-framework/scripts/*.php
            echo "‚úÖ Framework copied to crud6-framework"
          else
            echo "üì¶ Installing framework..."
            git clone --depth 1 --branch ${{ env.FRAMEWORK_BRANCH }} \
              https://github.com/${{ env.FRAMEWORK_REPO }}.git /tmp/crud6-repo
            mkdir -p .github/crud6-framework
            cp -r /tmp/crud6-repo/.github/testing-framework/* .github/crud6-framework/
            chmod +x .github/crud6-framework/scripts/*.php
            echo "‚úÖ Framework installed"
          fi
          
          mkdir -p .github/config
          if [ -d "/tmp/crud6-repo/.github/config" ]; then
            cp /tmp/crud6-repo/.github/config/integration-test-*.json .github/config/ 2>/dev/null || true
          fi
      
      - name: Create UserFrosting project
        run: |
          composer create-project userfrosting/userfrosting userfrosting "${{ env.UF_VERSION }}" \
            --no-scripts --no-install --ignore-platform-reqs
          
          cd userfrosting/app
          mkdir -p storage/sessions storage/cache storage/logs logs cache sessions
          chmod -R 777 storage sessions logs cache
          touch logs/userfrosting.log
      
      - name: Configure Composer dependencies
        run: |
          cd userfrosting
          
          if [ -d "/tmp/crud6-repo" ]; then
            composer config repositories.crud6 path /tmp/crud6-repo
            composer require ssnukala/sprinkle-crud6:@dev --no-update
          fi
          
          composer config repositories.local path ../${{ env.SPRINKLE_DIR }}
          composer require ${{ env.COMPOSER_PACKAGE }}:@dev --no-update
          
          composer config minimum-stability beta
          composer config prefer-stable true
          
          composer install --no-interaction --prefer-dist
      
      - name: Configure NPM dependencies
        run: |
          cd userfrosting
          npm update
          
          if [ -d "/tmp/crud6-repo" ]; then
            cd /tmp/crud6-repo
            npm pack
            mv ssnukala-sprinkle-crud6-*.tgz "$GITHUB_WORKSPACE/userfrosting/"
            cd "$GITHUB_WORKSPACE/userfrosting"
            npm install ./ssnukala-sprinkle-crud6-*.tgz
          fi
          
          cd "$GITHUB_WORKSPACE/${{ env.SPRINKLE_DIR }}"
          npm pack 2>/dev/null || true
          if ls *.tgz 1> /dev/null 2>&1; then
            mv *.tgz "$GITHUB_WORKSPACE/userfrosting/"
            cd "$GITHUB_WORKSPACE/userfrosting"
            npm install ./*.tgz 2>/dev/null || echo "NPM package optional"
          fi
      
      - name: Configure MyApp.php
        run: |
          cd userfrosting
          
          sed -i '/use UserFrosting\\Sprinkle\\Core\\Core;/a use UserFrosting\\Sprinkle\\CRUD6\\CRUD6;' app/src/MyApp.php
          sed -i '/Admin::class,/a \            CRUD6::class,' app/src/MyApp.php
          
          echo ""
          echo "‚úÖ MyApp.php configured"
          echo "Updated app/src/MyApp.php:"
          cat app/src/MyApp.php
      
      - name: Configure main.ts
        run: |
          cd userfrosting
          
          sed -i "/import AdminSprinkle from '@userfrosting\\/sprinkle-admin'/a import CRUD6Sprinkle from '@ssnukala\\/sprinkle-crud6'" app/assets/main.ts
          sed -i "/app.use(AdminSprinkle)/a app.use(CRUD6Sprinkle)" app/assets/main.ts
          
          echo ""
          echo "‚úÖ main.ts configured"
          echo "Updated app/assets/main.ts:"
          cat app/assets/main.ts
      
      - name: Configure routes (simple pattern)
        run: |
          cd userfrosting
          
          # Simple array spread pattern
          sed -i "/import AdminRoutes from '@userfrosting\\/sprinkle-admin\\/routes'/a import CRUD6Routes from '@ssnukala/sprinkle-crud6/routes'" app/assets/router/index.ts
          sed -i "/\\.\\.\\.AccountRoutes,/a \\            ...CRUD6Routes," app/assets/router/index.ts

          echo ""
          echo "‚úÖ Routes configured (simple pattern)"
          echo "Updated app/assets/router/index.ts:"
          cat app/assets/router/index.ts

      
      - name: Verify NPM package installation
        run: |
          cd userfrosting
          # Verify the package is installed correctly
          npm list ${{ env.NPM_PACKAGE }} || echo "Package installed as local dependency"
          # Check that the package files are accessible
          test -f node_modules/${{ env.NPM_PACKAGE }}/app/assets/index.ts && echo "‚úÖ NPM package files accessible" || echo "‚ö†Ô∏è NPM package files not found"

      - name: Configure vite.config.ts for CommonJS dependencies
        run: |
          cd userfrosting
          # Configure vite.config.ts to handle CommonJS dependencies (limax and lodash.deburr)
          # sprinkle-crud6 uses limax which depends on lodash.deburr (CommonJS modules)
          # These need to be pre-bundled by Vite to work properly

          # Check if already configured
          if grep -q "'limax'" vite.config.ts || grep -q '"limax"' vite.config.ts; then
            echo "limax already in vite.config.ts, skipping configuration"
          elif grep -q "optimizeDeps:" vite.config.ts; then
            echo "optimizeDeps section exists, checking for include array..."
            if grep -q "include:" vite.config.ts; then
              echo "include array exists, adding limax and lodash.deburr to it..."
              # Add to existing include array using awk (handles both single-line and multi-line)
              awk '
                /include: \[/ {
                  if (/\]/) {
                    # Single-line array: include: [...]
                    sub(/\]/, ", '\''limax'\'', '\''lodash.deburr'\'']");
                    print;
                    next;
                  } else {
                    # Multi-line array start
                    print;
                    in_array=1;
                    next;
                  }
                }
                in_array {
                  if (/\]/) {
                    # Multi-line array end - add items before closing bracket
                    print "            '\''limax'\'',";
                    print "            '\''lodash.deburr'\''";
                    print $0;
                    in_array=0;
                    next;
                  } else {
                    # Inside array - ensure trailing comma
                    if (!/,$/) {
                      sub(/$/, ",");
                    }
                    print;
                    next;
                  }
                }
                {print}
              ' vite.config.ts > vite.config.ts.tmp && mv vite.config.ts.tmp vite.config.ts
            else
              echo "include array doesn't exist, creating it..."
              # Add include array to optimizeDeps
              sed -i "/optimizeDeps: {/a \\        include: ['limax', 'lodash.deburr']," vite.config.ts
            fi
          else
            echo "optimizeDeps section doesn't exist, creating it..."
            # Add optimizeDeps section after plugins block
            # This handles both single-line (plugins: [...],) and multi-line plugins arrays
            awk '
              /plugins:/ {in_plugins=1} 
              in_plugins && /\],/ {
                print;
                print "    optimizeDeps: {";
                print "        // Include CommonJS dependencies for sprinkle-crud6";
                print "        // limax uses lodash.deburr which is a CommonJS module";
                print "        include: ['\''limax'\'', '\''lodash.deburr'\'']";
                print "    },";
                in_plugins=0;
                next;
              } 
              {print}
            ' vite.config.ts > vite.config.ts.tmp && mv vite.config.ts.tmp vite.config.ts
          fi

          echo ""
          echo "‚úÖ Vite configuration updated for CommonJS dependencies"
          echo "Updated vite.config.ts:"
          cat vite.config.ts

      
      - name: Setup environment
        run: |
          cd userfrosting
          cp app/.env.example app/.env
          sed -i 's/DB_CONNECTION=.*/DB_CONNECTION="mysql"/' app/.env
          sed -i 's/DB_HOST=.*/DB_HOST="127.0.0.1"/' app/.env
          sed -i 's/DB_PORT=.*/DB_PORT="3306"/' app/.env
          sed -i 's/DB_NAME=.*/DB_NAME="userfrosting_test"/' app/.env
          sed -i 's/DB_USER=.*/DB_USER="root"/' app/.env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD="root"/' app/.env
          echo "BAKERY_CONFIRM_SENSITIVE_COMMAND=false" >> app/.env
          echo "TEST_SESSION_HANDLER=database" >> app/.env
      
      - name: Run migrations
        run: |
          cd userfrosting
          php bakery migrate --force
      
      - name: Create admin user
        run: |
          cd userfrosting
          set +e  # Don't exit immediately on error so we can capture output
          OUTPUT=$(php bakery create:admin-user \
            --username=admin \
            --password=admin123 \
            --email=admin@example.com \
            --firstName=Admin \
            --lastName=User 2>&1)
          EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          echo "$OUTPUT"
          
          # Check both exit code and success message
          if [ $EXIT_CODE -eq 0 ]; then
            if echo "$OUTPUT" | grep -Eqi "(user creation successful|created successfully|successfully created)"; then
              echo "‚úÖ Admin user created successfully"
            else
              echo "‚ö†Ô∏è  Command succeeded (exit code 0) but expected success message not found"
              echo "    Checking if user creation output is present..."
              if echo "$OUTPUT" | grep -qi "admin"; then
                echo "‚úÖ User 'admin' found in output - proceeding"
              else
                echo "‚úÖ Proceeding based on exit code 0"
              fi
            fi
          else
            echo "‚ùå Failed to create admin user (exit code: $EXIT_CODE)"
            exit 1
          fi
      
      - name: Copy CRUD6 schema files from examples
        run: |
          cd userfrosting
          echo "========================================="
          echo "Copying CRUD6 Schema Files from Examples"
          echo "========================================="

          # Create schema directory if it doesn't exist
          mkdir -p app/schema/crud6

          # Define the schema files needed for integration tests
          REQUIRED_SCHEMAS="users.json groups.json roles.json permissions.json activities.json"

          # Check that source directory exists
          if [ ! -d "../${{ env.SPRINKLE_DIR }}/examples/schema" ]; then
            echo "‚ùå ERROR: Source schema directory not found: ../${{ env.SPRINKLE_DIR }}/examples/schema"
            exit 1
          fi

          # Copy required schema files
          echo ""
          echo "Copying required schema files..."
          for schema in $REQUIRED_SCHEMAS; do
            if [ -f "../${{ env.SPRINKLE_DIR }}/examples/schema/$schema" ]; then
              cp "../${{ env.SPRINKLE_DIR }}/examples/schema/$schema" "app/schema/crud6/"
              echo "  ‚úÖ Copied: $schema"
            else
              echo "  ‚ö†Ô∏è  WARNING: Schema file not found: $schema"
            fi
          done

          # Verify schemas were copied
          echo ""
          echo "========================================="
          echo "Schemas copied to app/schema/crud6/:"
          echo "========================================="
          ls -la app/schema/crud6/

          # Validate all required schemas are present
          echo ""
          echo "Validating required schemas..."
          MISSING=0
          for schema in $REQUIRED_SCHEMAS; do
            if [ ! -f "app/schema/crud6/$schema" ]; then
              echo "  ‚ùå MISSING: $schema"
              MISSING=1
            fi
          done

          if [ $MISSING -eq 1 ]; then
            echo "‚ùå ERROR: Some required schema files are missing!"
            exit 1
          else
            echo "‚úÖ All required schema files are present"
          fi
      
      - name: Merge locale messages from examples
        run: |
          cd userfrosting
          echo "========================================="
          echo "Merging Locale Messages from Examples"
          echo "========================================="

          # Create locale directory if it doesn't exist
          mkdir -p app/locale/en_US

          # Check that source messages file exists
          if [ ! -f "../${{ env.SPRINKLE_DIR }}/examples/locale/en_US/messages.php" ]; then
            echo "‚ùå ERROR: Source messages file not found: ../${{ env.SPRINKLE_DIR }}/examples/locale/en_US/messages.php"
            exit 1
          fi

          # Check if destination messages file already exists in sprinkle-crud6's app/locale
          if [ -f "../${{ env.SPRINKLE_DIR }}/app/locale/en_US/messages.php" ]; then
            echo "Found existing app/locale messages file, copying to userfrosting app..."
            cp "../${{ env.SPRINKLE_DIR }}/app/locale/en_US/messages.php" "app/locale/en_US/messages.php"
            echo "  ‚úÖ Copied: messages.php from sprinkle-crud6/app/locale"
          fi

          # Now merge example messages (append model-specific translations)
          echo ""
          echo "Merging example messages (model-specific translations)..."

          # Create a PHP script to merge the message files
          cat > /tmp/merge-messages.php << 'MERGE_SCRIPT'
          <?php
          /**
           * Merge example messages with existing messages.php
           * This adds model-specific translations for CRUD6 testing
           */

          $examplesPath = $argv[1] ?? '';
          $destPath = $argv[2] ?? '';

          if (empty($examplesPath) || empty($destPath)) {
              echo "Usage: php merge-messages.php <examples_messages_path> <dest_messages_path>\n";
              exit(1);
          }

          // Load existing messages if they exist
          $existingMessages = [];
          if (file_exists($destPath)) {
              $existingMessages = require $destPath;
              echo "  Loaded existing messages from: $destPath\n";
          }

          // Load example messages
          if (!file_exists($examplesPath)) {
              echo "  ‚ùå Examples messages file not found: $examplesPath\n";
              exit(1);
          }
          $exampleMessages = require $examplesPath;
          echo "  Loaded example messages from: $examplesPath\n";

          // Deep merge function
          function deepMerge(array $base, array $override): array {
              foreach ($override as $key => $value) {
                  if (is_array($value) && isset($base[$key]) && is_array($base[$key])) {
                      $base[$key] = deepMerge($base[$key], $value);
                  } else {
                      $base[$key] = $value;
                  }
              }
              return $base;
          }

          // Merge messages (example messages override existing)
          $mergedMessages = deepMerge($existingMessages, $exampleMessages);

          // Generate the merged PHP file
          $output = "<?php\n\n";
          $output .= "/*\n";
          $output .= " * UserFrosting CRUD6 Sprinkle (http://www.userfrosting.com)\n";
          $output .= " *\n";
          $output .= " * @link      https://github.com/userfrosting/sprinkle-crud6\n";
          $output .= " * @copyright Copyright (c) 2013-2024 Alexander Weissman & Louis Charette\n";
          $output .= " * @license   https://github.com/userfrosting/sprinkle-crud6/blob/master/LICENSE.md (MIT License)\n";
          $output .= " */\n\n";
          $output .= "/**\n";
          $output .= " * US English message token translations for the 'crud6' sprinkle.\n";
          $output .= " * Merged from app/locale and examples/locale for integration testing.\n";
          $output .= " *\n";
          $output .= " * @author Alexander Weissman\n";
          $output .= " */\n";
          $output .= "return " . var_export($mergedMessages, true) . ";\n";

          // Write merged messages
          file_put_contents($destPath, $output);
          echo "  ‚úÖ Merged messages written to: $destPath\n";

          // Verify the file is valid PHP
          exec("php -l $destPath 2>&1", $lintOutput, $lintReturnCode);
          if ($lintReturnCode !== 0) {
              echo "  ‚ùå ERROR: Generated messages file has syntax errors!\n";
              echo "  " . implode("\n  ", $lintOutput) . "\n";
              exit(1);
          }
          echo "  ‚úÖ Syntax validation passed\n";
          MERGE_SCRIPT

          # Run the merge script
          php /tmp/merge-messages.php \
            "../${{ env.SPRINKLE_DIR }}/examples/locale/en_US/messages.php" \
            "app/locale/en_US/messages.php"

          echo ""
          echo "========================================="
          echo "Locale Messages Merge Complete"
          echo "========================================="
          echo ""
          echo "Messages file content preview (first 50 lines):"
          head -n 50 app/locale/en_US/messages.php
          echo "..."
      
      - name: Generate and create tables from schemas
        run: |
          cd userfrosting
          
          SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/${{ env.SCHEMA_PATH }}"
          if [ -z "${{ env.SCHEMA_PATH }}" ]; then
            SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/app/schema/crud6"
          fi
          
          if [ ! -d "$SCHEMA_DIR" ]; then
            echo "‚ùå ERROR: Schema directory not found: $SCHEMA_DIR"
            exit 1
          fi
          
          echo "‚úÖ Using schemas from: $SCHEMA_DIR"
          
          # Generate DDL (CREATE TABLE statements) from schemas
          node ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/generate-ddl-sql.js \
            "$SCHEMA_DIR" tables.sql
          
          # Create tables from DDL
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/load-seed-sql.php \
            tables.sql
          
          echo "‚úÖ Tables created from schemas"
      
      - name: Generate and load SQL seed data
        run: |
          cd userfrosting
          
          SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/${{ env.SCHEMA_PATH }}"
          if [ -z "${{ env.SCHEMA_PATH }}" ]; then
            SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/app/schema/crud6"
          fi
          
          # Generate seed data
          node ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/generate-seed-sql.js \
            "$SCHEMA_DIR" seed-data.sql
          
          # Load seed data
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/load-seed-sql.php \
            seed-data.sql
          
          echo "‚úÖ Schema-driven SQL loaded"

      - name: Run PHP seeds
        run: |
          cd userfrosting
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/run-seeds.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-seeds.json
      
      - name: Validate seed data
        run: |
          cd userfrosting
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/check-seeds-modular.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-seeds.json
      
      - name: Test seed idempotency
        run: |
          cd userfrosting
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-seed-idempotency-modular.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-seeds.json

      - name: Build frontend assets
        run: |
          cd userfrosting
          # UserFrosting 6 uses bakery bake to build assets via Vite
          # Note: Even though we bake, we still need vite dev server for proper asset serving
          php bakery bake || echo "‚ö†Ô∏è Build failed but continuing with tests"
      
      - name: Start PHP development server
        run: |
          cd userfrosting
          # Start PHP server using bakery serve in background
          php bakery serve &
          SERVER_PID=$!
          echo $SERVER_PID > /tmp/server.pid
          sleep 10

          # Test if server is running
          curl -f http://localhost:8080 || (echo "‚ö†Ô∏è Server may not be ready yet" && sleep 5 && curl -f http://localhost:8080)
          echo "‚úÖ PHP server started on localhost:8080"

      - name: Start Vite development server
        run: |
          cd userfrosting
          # Use npm update to fix any package issues
          npm update
          # Start Vite server in background using bakery command (follows UF6 standards)
          php bakery assets:vite &
          VITE_PID=$!
          echo $VITE_PID > /tmp/vite.pid

          # Wait longer for Vite to fully start up
          echo "Waiting for Vite server to start..."
          sleep 20

          # Try to verify Vite is running by checking if the page loads properly
          echo "Testing if frontend is accessible..."
          curl -f http://localhost:8080 || echo "‚ö†Ô∏è  Page load test after Vite start"

          echo "‚úÖ Vite server started"

      - name: Test unauthenticated API paths
        env:
          CONTINUE_ON_FAILURE: 'true'
        run: |
          cd userfrosting
          echo "========================================="
          echo "Testing Unauthenticated API Paths"
          echo "========================================="
          echo "Testing that protected API resources return 401/403 for unauthenticated users"
          echo ""
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-paths.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-paths.json \
            unauth api > /tmp/test-results-unauth-api.txt 2>&1
          cat /tmp/test-results-unauth-api.txt
      
      - name: Test unauthenticated frontend paths
        env:
          CONTINUE_ON_FAILURE: 'true'
        run: |
          cd userfrosting
          echo "========================================="
          echo "Testing Unauthenticated Frontend Paths"
          echo "========================================="
          echo "Testing that protected frontend pages redirect to login for unauthenticated users"
          echo ""
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-paths.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-paths.json \
            unauth frontend > /tmp/test-results-unauth-frontend.txt 2>&1
          cat /tmp/test-results-unauth-frontend.txt
      
      - name: Install Playwright
        run: |
          cd userfrosting
          npm install playwright
          npx playwright install chromium
      
      - name: Copy testing scripts to userfrosting
        run: |
          cd userfrosting
          # Copy scripts to userfrosting so they can access node_modules
          cp ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-authenticated-unified.js .
          cp ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/take-screenshots-modular.js .
          echo "‚úÖ Testing scripts copied to userfrosting directory"
      
      - name: Test authenticated paths (unified approach - login + API + frontend)
        run: |
          cd userfrosting
          echo "========================================="
          echo "Testing Authenticated Paths (Unified)"
          echo "========================================="
          echo "This test performs login and immediately tests"
          echo "authenticated API endpoints and frontend pages"
          echo "in a single session to maintain authentication state"
          echo ""
          
          # Run unified test that does login + API tests + frontend tests in one go
          # Note: Script exits with code 1 on failure, which will fail this workflow step
          node test-authenticated-unified.js \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-paths.json \
            http://localhost:8080 \
            admin \
            admin123
      
      - name: Generate test summary table
        if: always()
        run: |
          cd userfrosting
          echo ""
          echo "========================================="
          echo "INTEGRATION TEST RESULTS SUMMARY"
          echo "========================================="
          echo ""
          
          # Create summary table
          cat << 'EOF' > /tmp/test-summary.txt
          | Test Category | Auth Status | Type | Status | Details |
          |---------------|-------------|------|--------|---------|
          EOF
          
          # Function to extract summary from test results
          extract_summary() {
            local file=$1
            local auth_status=$2
            local type=$3
            
            if [ -f "$file" ]; then
              # Extract test counts
              local total=$(grep "Total tests:" "$file" | awk '{print $3}' || echo "0")
              local passed=$(grep "Passed:" "$file" | awk '{print $2}' || echo "0")
              local warnings=$(grep "Warnings:" "$file" | awk '{print $2}' || echo "0")
              local failed=$(grep "Failed:" "$file" | awk '{print $2}' || echo "0")
              
              # Determine status
              local status="‚úÖ PASS"
              if [ "$failed" -gt 0 ]; then
                status="‚ùå FAIL"
              elif [ "$warnings" -gt 0 ]; then
                status="‚ö†Ô∏è  WARN"
              fi
              
              # Format details
              local details="Total: $total, Passed: $passed, Warnings: $warnings, Failed: $failed"
              
              echo "| Step $step | $auth_status | $type | $status | $details |" >> /tmp/test-summary.txt
              step=$((step + 1))
            else
              echo "| Step $step | $auth_status | $type | ‚ùå ERROR | Test file not found |" >> /tmp/test-summary.txt
              step=$((step + 1))
            fi
          }
          
          # Initialize step counter
          step=1
          
          # Extract summaries for test runs (only unauthenticated tests now write to files)
          extract_summary "/tmp/test-results-unauth-api.txt" "Unauthenticated" "API"
          extract_summary "/tmp/test-results-unauth-frontend.txt" "Unauthenticated" "Frontend"
          
          # Note: Authenticated tests are now done via unified JS script (results shown in console)
          echo "| Step 3 | Authenticated | API+Frontend | See console output | Unified test approach |" >> /tmp/test-summary.txt
          
          # Display the summary table
          cat /tmp/test-summary.txt
          echo ""
          
          # Overall summary for unauthenticated tests
          echo "========================================="
          echo "OVERALL TEST SUMMARY"
          echo "========================================="
          
          total_tests=0
          total_passed=0
          total_warnings=0
          total_failed=0
          
          for file in /tmp/test-results-*.txt; do
            if [ -f "$file" ]; then
              tests=$(grep "Total tests:" "$file" | awk '{print $3}' || echo "0")
              passed=$(grep "Passed:" "$file" | awk '{print $2}' || echo "0")
              warnings=$(grep "Warnings:" "$file" | awk '{print $2}' || echo "0")
              failed=$(grep "Failed:" "$file" | awk '{print $2}' || echo "0")
              
              total_tests=$((total_tests + tests))
              total_passed=$((total_passed + passed))
              total_warnings=$((total_warnings + warnings))
              total_failed=$((total_failed + failed))
            fi
          done
          
          echo "Unauthenticated Tests: $total_tests executed"
          echo "‚úÖ Passed: $total_passed"
          echo "‚ö†Ô∏è  Warnings: $total_warnings (expected for access control)"
          echo "‚ùå Failed: $total_failed"
          echo ""
          echo "Authenticated Tests: See unified test output above"
          echo ""
          
          if [ "$total_failed" -gt 0 ]; then
            echo "‚ö†Ô∏è  Some unauthenticated tests failed"
          elif [ "$total_warnings" -gt 0 ]; then
            echo "‚úÖ Unauthenticated tests passed (warnings are expected for access control)"
          else
            echo "‚úÖ All unauthenticated tests passed"
          fi
          
          echo ""
          echo "Note: Authenticated test results are from unified script (login + API + frontend in one session)"

      - name: Capture screenshots (if not already captured by unified test)
        if: always()
        run: |
          cd userfrosting
          # Note: The unified test script already captures screenshots
          # This step is kept for compatibility but will skip if screenshots already exist
          
          # Count existing screenshots
          SCREENSHOT_COUNT=$(ls -1 /tmp/screenshot_*.png 2>/dev/null | wc -l || echo "0")
          
          if [ "$SCREENSHOT_COUNT" -gt 0 ]; then
            echo "‚úÖ Found $SCREENSHOT_COUNT screenshot(s) already captured by unified test"
            echo "Skipping additional screenshot capture"
          else
            echo "üì∏ No screenshots found - capturing now"
            # Perform fresh login and screenshot capture
            node take-screenshots-modular.js \
              ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-paths.json \
              http://localhost:8080 \
              admin \
              admin123
          fi

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-screenshots
          path: /tmp/screenshot_*.png
          retention-days: 7
      
      - name: Upload login diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: login-diagnostics
          path: |
            /tmp/login-page-before-attempt.png
            /tmp/login-error-screenshot.png
          retention-days: 7
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: userfrosting/app/logs/
          retention-days: 7
      
      - name: Upload API test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-log
          path: /tmp/api-test-log.json
          if-no-files-found: ignore
          retention-days: 7
      
      - name: Run PHPUnit tests from sprinkle
        run: |
          cd userfrosting
          echo "========================================="
          echo "Running PHPUnit Tests from CRUD6 Sprinkle"
          echo "========================================="
          echo ""
          echo "These tests verify CRUD6 functionality:"
          echo "  - Controller actions"
          echo "  - Model operations"
          echo "  - Schema services"
          echo "  - Integration tests"
          echo ""
          
          # Check if sprinkle is installed
          if [ ! -d "vendor/ssnukala/sprinkle-crud6" ]; then
            echo "‚ùå CRUD6 sprinkle not found in vendor directory"
            exit 1
          fi
          
          # Change to the sprinkle directory to run tests
          # This ensures the bootstrap path in phpunit.xml is correct
          cd vendor/ssnukala/sprinkle-crud6
          
          # Run PHPUnit using the sprinkle's phpunit.xml configuration
          # The tests will use the UserFrosting autoloader from the parent project
          if [ -f "phpunit.xml" ]; then
            echo "Running PHPUnit tests with sprinkle configuration..."
            ../../../vendor/bin/phpunit --testdox --colors=always
          else
            echo "‚ùå PHPUnit configuration not found in sprinkle"
            exit 1
          fi
          
          echo ""
          echo "========================================="
          echo "‚úÖ PHPUnit Tests Completed"
          echo "========================================="
      
      - name: Stop servers
        if: always()
        run: |
          if [ -f /tmp/server.pid ]; then
            kill $(cat /tmp/server.pid) || true
          fi
          if [ -f /tmp/vite.pid ]; then
            kill $(cat /tmp/vite.pid) || true
          fi
