name: CRUD6 Integration Test

# ============================================================================
# CRUD6 WORKFLOW TEMPLATE - Two Options for Using This File
# ============================================================================
#
# OPTION 1: Manual Copy (Quick Setup for CRUD6 Testing)
#   1. Copy to .github/workflows/crud6-integration-test.yml
#   2. Replace YOUR_SPRINKLE_NAME with your sprinkle directory name
#   3. Replace YOUR_COMPOSER_PACKAGE with your composer package name
#   4. Replace YOUR_NPM_PACKAGE with your npm package name
#   5. If schemas are NOT in app/schema/crud6/, set SCHEMA_PATH to correct path
#   6. The workflow will auto-install the framework and use CRUD6's test configuration
#
# OPTION 2: JSON-Driven Auto-Generation (RECOMMENDED)
#   1. Create integration-test-config.json with your CRUD6 configuration
#   2. Run: node .github/testing-framework/scripts/generate-workflow.js \
#             integration-test-config.json \
#             .github/workflows/crud6-integration-test.yml
#   3. Your CRUD6 workflow is automatically generated!
#
# This workflow focuses ONLY on CRUD6 functionality testing
# Create separate workflows for your sprinkle-specific features
#
# See: .github/testing-framework/docs/JSON_DRIVEN_TESTING.md
# ============================================================================

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  # CUSTOMIZE THESE VALUES FOR YOUR SPRINKLE
  SPRINKLE_DIR: YOUR_SPRINKLE_NAME          # Your sprinkle directory name
  COMPOSER_PACKAGE: YOUR_COMPOSER_PACKAGE    # e.g., yourvendor/your-sprinkle
  NPM_PACKAGE: "YOUR_NPM_PACKAGE"           # e.g., "@yourvendor/your-sprinkle"
  
  # SCHEMA CONFIGURATION
  # If your sprinkle has schemas in app/schema/crud6/, leave this empty
  # If schemas are elsewhere, set the path relative to sprinkle root
  # Examples: 
  #   - "examples/schema" (for sprinkle-crud6 itself)
  #   - "app/schema/custom" (custom location)
  #   - "" (use app/schema/crud6/ - default for most sprinkles)
  SCHEMA_PATH: ""  # Leave empty to use app/schema/crud6/
  
  # Framework will be auto-installed from sprinkle-crud6
  FRAMEWORK_REPO: ssnukala/sprinkle-crud6
  FRAMEWORK_BRANCH: main

jobs:
  crud6-integration-test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: userfrosting_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      # ========================================================================
      # Checkout Your Sprinkle
      # ========================================================================
      - name: Checkout ${{ env.SPRINKLE_DIR }}
        uses: actions/checkout@v4
        with:
          path: ${{ env.SPRINKLE_DIR }}
      
      # ========================================================================
      # Setup PHP and Node.js
      # ========================================================================
      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: mbstring, xml, gd, pdo_mysql
          coverage: none
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      
      # ========================================================================
      # Install CRUD6 Testing Framework (Auto-Install)
      # ========================================================================
      - name: Install CRUD6 Testing Framework
        run: |
          cd ${{ env.SPRINKLE_DIR }}
          
          echo "========================================="
          echo "CRUD6 Testing Framework Setup"
          echo "========================================="
          echo ""
          
          # Check if framework is already installed locally
          if [ -d ".github/crud6-framework" ]; then
            echo "‚úÖ Framework found locally at .github/crud6-framework/"
            echo "   Using local version"
          else
            echo "üì¶ Framework not found locally - downloading from ${{ env.FRAMEWORK_REPO }}..."
            echo ""
            
            # Clone CRUD6 repository to get the framework
            git clone --depth 1 --branch ${{ env.FRAMEWORK_BRANCH }} \
              https://github.com/${{ env.FRAMEWORK_REPO }}.git /tmp/crud6-repo
            
            # Copy framework to local directory
            mkdir -p .github/crud6-framework
            cp -r /tmp/crud6-repo/.github/testing-framework/* .github/crud6-framework/
            
            # Make scripts executable
            chmod +x .github/crud6-framework/scripts/*.php
            chmod +x .github/crud6-framework/install.sh
            
            echo "‚úÖ Framework installed to .github/crud6-framework/"
            echo ""
            echo "‚ÑπÔ∏è  NOTE: The framework is installed locally for this CI run."
            echo "   To persist it, commit .github/crud6-framework/ to your repository."
            echo "   This allows offline testing and custom configuration."
          fi
          
          # List installed framework files
          echo ""
          echo "Framework contents:"
          ls -la .github/crud6-framework/
          echo ""
          echo "Available scripts:"
          ls -1 .github/crud6-framework/scripts/
          echo ""
          echo "========================================="
      
      # ========================================================================
      # Use CRUD6 Test Configuration
      # ========================================================================
      - name: Setup CRUD6 test configuration
        run: |
          cd ${{ env.SPRINKLE_DIR }}
          
          echo "========================================="
          echo "CRUD6 Test Configuration"
          echo "========================================="
          echo ""
          
          # Use CRUD6's own test configuration
          # This tests the standard CRUD6 models: users, groups, roles, permissions, activities
          
          if [ -d ".github/crud6-framework/config" ]; then
            echo "Using CRUD6 framework's default test configuration:"
            echo "  - integration-test-paths.json (CRUD6 API/frontend paths)"
            echo "  - integration-test-seeds.json (CRUD6 seeds)"
            echo ""
            
            # Create config directory if needed
            mkdir -p .github/config
            
            # Copy CRUD6's test configs (from the cloned framework)
            # These are in the parent crud6-repo since we cloned the whole repo
            if [ -d "/tmp/crud6-repo/.github/config" ]; then
              cp /tmp/crud6-repo/.github/config/integration-test-paths.json .github/config/ 2>/dev/null || \
                echo "‚ö†Ô∏è  Using framework template paths"
              cp /tmp/crud6-repo/.github/config/integration-test-seeds.json .github/config/ 2>/dev/null || \
                echo "‚ö†Ô∏è  Using framework template seeds"
            fi
            
            echo "‚úÖ Test configuration ready"
          else
            echo "‚ùå ERROR: Framework config not found"
            exit 1
          fi
      
      # ========================================================================
      # NOTE: Schema Files
      # ========================================================================
      # Your sprinkle should already have schema files in app/schema/crud6/
      # This workflow assumes your sprinkle contains CRUD6 schema definitions
      # 
      # Example: https://github.com/ssnukala/sprinkle-c6admin/tree/main/app/schema/crud6
      # 
      # If your sprinkle doesn't have schemas yet, add them before running this workflow
      # ========================================================================
      # Create UserFrosting Project
      # ========================================================================
      - name: Create UserFrosting project
        run: |
          composer create-project userfrosting/userfrosting userfrosting "^6.0-beta" \
            --no-scripts --no-install --ignore-platform-reqs
          
          # Create runtime directories
          cd userfrosting/app
          mkdir -p storage/sessions storage/cache storage/logs logs cache sessions
          chmod -R 777 storage sessions logs cache
          touch logs/userfrosting.log
      
      # ========================================================================
      # Configure Composer - Install CRUD6 + Your Sprinkle
      # ========================================================================
      - name: Configure Composer
        run: |
          cd userfrosting
          
          # Add CRUD6 from local path (the cloned repo)
          composer config repositories.crud6 path ../../../tmp/crud6-repo
          composer require ssnukala/sprinkle-crud6:@dev --no-update
          
          # Add your sprinkle from local path
          composer config repositories.local path ../${{ env.SPRINKLE_DIR }}
          composer require ${{ env.COMPOSER_PACKAGE }}:@dev --no-update
          
          # Configure for beta packages
          composer config minimum-stability beta
          composer config prefer-stable true
      
      - name: Install PHP dependencies
        run: |
          cd userfrosting
          composer install --no-interaction --prefer-dist
      
      # ========================================================================
      # Configure NPM - Install CRUD6 + Your Sprinkle
      # ========================================================================
      - name: Install NPM dependencies
        run: |
          cd userfrosting
          npm update
          
          # Install CRUD6 from the cloned repo
          cd ../../../tmp/crud6-repo
          npm pack
          mv ssnukala-sprinkle-crud6-*.tgz ../../work/${{ env.SPRINKLE_DIR }}/${{ env.SPRINKLE_DIR }}/userfrosting/
          
          # Install your sprinkle
          cd ../../work/${{ env.SPRINKLE_DIR }}/${{ env.SPRINKLE_DIR }}
          npm pack
          mv *.tgz userfrosting/ 2>/dev/null || true
          
          # Install both packages
          cd userfrosting
          npm install ./ssnukala-sprinkle-crud6-*.tgz
          npm install ./*.tgz 2>/dev/null || echo "Your sprinkle may not have NPM package"
      
      # ========================================================================
      # Configure UserFrosting App
      # ========================================================================
      - name: Configure MyApp.php
        run: |
          cd userfrosting
          
          # Add CRUD6 sprinkle
          sed -i '/use UserFrosting\\Sprinkle\\Core\\Core;/a use UserFrosting\\Sprinkle\\CRUD6\\CRUD6;' app/src/MyApp.php
          sed -i '/Admin::class,/a \            CRUD6::class,' app/src/MyApp.php
          
          echo "MyApp.php configured with CRUD6"
          cat app/src/MyApp.php
      
      # ========================================================================
      # Configure Frontend (CRUD6 Routes)
      # ========================================================================
      - name: Configure router/index.ts for CRUD6
        run: |
          cd userfrosting
          
          # Add CRUD6 routes (simple pattern)
          sed -i "/import AdminRoutes from '@userfrosting\/sprinkle-admin\/routes'/a import CRUD6Routes from '@ssnukala\/sprinkle-crud6\/routes'" app/assets/router/index.ts
          sed -i '/\.\.\.AccountRoutes,/a \            ...CRUD6Routes,' app/assets/router/index.ts
          
          cat app/assets/router/index.ts
      
      - name: Configure main.ts for CRUD6
        run: |
          cd userfrosting
          
          # Add CRUD6 sprinkle
          sed -i "/import AdminSprinkle from '@userfrosting\/sprinkle-admin'/a import CRUD6Sprinkle from '@ssnukala\/sprinkle-crud6'" app/assets/main.ts
          sed -i "/app.use(AdminSprinkle)/a app.use(CRUD6Sprinkle)" app/assets/main.ts
          
          cat app/assets/main.ts
      
      # ========================================================================
      # Setup Environment
      # ========================================================================
      - name: Setup environment
        run: |
          cd userfrosting
          cp app/.env.example app/.env
          sed -i 's/DB_CONNECTION=.*/DB_CONNECTION="mysql"/' app/.env
          sed -i 's/DB_HOST=.*/DB_HOST="127.0.0.1"/' app/.env
          sed -i 's/DB_PORT=.*/DB_PORT="3306"/' app/.env
          sed -i 's/DB_NAME=.*/DB_NAME="userfrosting_test"/' app/.env
          sed -i 's/DB_USER=.*/DB_USER="root"/' app/.env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD="root"/' app/.env
          echo "BAKERY_CONFIRM_SENSITIVE_COMMAND=false" >> app/.env
          echo "TEST_SESSION_HANDLER=database" >> app/.env
      
      # ========================================================================
      # Run Migrations
      # ========================================================================
      - name: Run migrations
        run: |
          cd userfrosting
          php bakery migrate --force
      
      # ========================================================================
      # Generate SQL Seed Data from Schemas (Common for all CRUD6 sprinkles)
      # ========================================================================
      - name: Generate SQL seed data from schemas
        run: |
          cd userfrosting
          
          echo "========================================="
          echo "Generating SQL Seed Data from Schemas"
          echo "========================================="
          echo ""
          
          # Determine schema path
          if [ -z "${{ env.SCHEMA_PATH }}" ]; then
            # Default: use app/schema/crud6/ in the sprinkle
            SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/app/schema/crud6"
            SCHEMA_SOURCE="app/schema/crud6 (default location)"
          else
            # Custom path specified
            SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/${{ env.SCHEMA_PATH }}"
            SCHEMA_SOURCE="${{ env.SCHEMA_PATH }} (custom location)"
          fi
          
          echo "Schema directory: $SCHEMA_SOURCE"
          echo "Full path: $SCHEMA_DIR"
          echo ""
          
          # Check if schema directory exists
          if [ ! -d "$SCHEMA_DIR" ]; then
            echo "‚ùå ERROR: Schema directory not found!"
            echo ""
            echo "Expected location: $SCHEMA_DIR"
            echo ""
            echo "CONFIGURATION REQUIRED:"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""
            echo "Your sprinkle needs CRUD6 schema JSON files for testing."
            echo ""
            echo "Option 1: Standard location (recommended)"
            echo "  - Create schemas at: ${{ env.SPRINKLE_DIR }}/app/schema/crud6/"
            echo "  - Example: https://github.com/ssnukala/sprinkle-c6admin/tree/main/app/schema/crud6"
            echo "  - Leave SCHEMA_PATH empty in workflow"
            echo ""
            echo "Option 2: Custom location"
            echo "  - Put your schemas in a different folder"
            echo "  - Set SCHEMA_PATH in the workflow env section"
            echo "  - Example: SCHEMA_PATH: \"examples/schema\""
            echo ""
            echo "Option 3: Copy from examples (sprinkle-crud6 only)"
            echo "  - If your sprinkle IS sprinkle-crud6 itself"
            echo "  - Set SCHEMA_PATH: \"examples/schema\""
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            exit 1
          fi
          
          # Count schema files
          SCHEMA_COUNT=$(ls -1 $SCHEMA_DIR/*.json 2>/dev/null | wc -l)
          if [ "$SCHEMA_COUNT" -eq 0 ]; then
            echo "‚ùå ERROR: No schema JSON files found!"
            echo ""
            echo "Searched in: $SCHEMA_DIR"
            echo ""
            echo "Please add CRUD6 schema JSON files to this directory."
            echo "Each schema defines a model's structure, fields, and validation rules."
            echo ""
            echo "Example schemas: https://github.com/ssnukala/sprinkle-crud6/tree/main/examples/schema"
            exit 1
          fi
          
          echo "‚úÖ Found $SCHEMA_COUNT schema file(s):"
          ls -1 $SCHEMA_DIR/*.json
          echo ""
          
          # Create output directory
          mkdir -p app/sql/seeds
          
          # Copy generate-seed-sql.js from CRUD6 repo
          if [ -f "/tmp/crud6-repo/.github/scripts/generate-seed-sql.js" ]; then
            cp /tmp/crud6-repo/.github/scripts/generate-seed-sql.js .
            
            # Generate SQL from schemas
            echo "Generating SQL seed data from schemas..."
            node generate-seed-sql.js $SCHEMA_DIR app/sql/seeds/crud6-test-data.sql
            
            echo ""
            echo "‚úÖ Generated SQL seed data:"
            ls -lh app/sql/seeds/crud6-test-data.sql
            
            # Show preview
            echo ""
            echo "Preview (first 15 lines):"
            head -15 app/sql/seeds/crud6-test-data.sql
          else
            echo "‚ùå ERROR: generate-seed-sql.js not found in CRUD6 framework"
            exit 1
          fi
      
      # ========================================================================
      # Load SQL Seed Data (if generated)
      # ========================================================================
      - name: Load SQL seed data
        run: |
          cd userfrosting
          
          # Check if SQL file was generated
          if [ -f "app/sql/seeds/crud6-test-data.sql" ]; then
            echo "========================================="
            echo "Loading SQL Seed Data"
            echo "========================================="
            echo ""
            
            # Copy load-seed-sql.php from CRUD6 repo
            if [ -f "/tmp/crud6-repo/.github/scripts/load-seed-sql.php" ]; then
              cp /tmp/crud6-repo/.github/scripts/load-seed-sql.php .
              
              # Load SQL into database
              php load-seed-sql.php app/sql/seeds/crud6-test-data.sql
              
              echo ""
              echo "‚úÖ SQL seed data loaded successfully"
            else
              echo "‚ö†Ô∏è  WARNING: load-seed-sql.php not found"
              echo "   Skipping SQL load - will use PHP seeds only"
            fi
          else
            echo "‚ÑπÔ∏è  No SQL seed file found - will use PHP seeds only"
          fi
      
      # ========================================================================
      # Run CRUD6 Seeds Using Framework
      # ========================================================================
      - name: Run CRUD6 seeds
        run: |
          cd userfrosting
          
          # Copy framework script and CRUD6 test config
          cp ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/run-seeds.php .
          cp ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-seeds.json .
          
          # Run seeds
          php run-seeds.php integration-test-seeds.json
      
      # ========================================================================
      # Validate CRUD6 Seeds
      # ========================================================================
      - name: Validate CRUD6 seeds
        run: |
          cd userfrosting
          
          cp ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/check-seeds-modular.php .
          php check-seeds-modular.php integration-test-seeds.json
      
      # ========================================================================
      # Test Seed Idempotency
      # ========================================================================
      - name: Test seed idempotency
        run: |
          cd userfrosting
          
          cp ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-seed-idempotency-modular.php .
          
          BEFORE=$(php test-seed-idempotency-modular.php integration-test-seeds.json | grep "BEFORE:")
          php run-seeds.php integration-test-seeds.json
          php test-seed-idempotency-modular.php integration-test-seeds.json after "$BEFORE"
      
      # ========================================================================
      # Create Admin User
      # ========================================================================
      - name: Create admin user
        run: |
          cd userfrosting
          php bakery create:admin-user \
            --username=admin \
            --password=admin123 \
            --email=admin@example.com \
            --firstName=Admin \
            --lastName=User
      
      # ========================================================================
      # Build and Start Servers
      # ========================================================================
      - name: Install Playwright
        run: |
          cd userfrosting
          npm install playwright
          npx playwright install chromium --with-deps
      
      - name: Build frontend assets
        run: |
          cd userfrosting
          php bakery bake || echo "‚ö†Ô∏è Build failed but continuing"
      
      - name: Start PHP server
        run: |
          cd userfrosting
          php bakery serve &
          sleep 10
          curl -f http://localhost:8080 || echo "‚ö†Ô∏è Server starting"
      
      - name: Start Vite server
        run: |
          cd userfrosting
          php bakery assets:vite &
          sleep 20
      
      # ========================================================================
      # Test CRUD6 Paths Using Framework
      # ========================================================================
      - name: Test CRUD6 API and frontend paths
        run: |
          cd userfrosting
          
          # Copy framework script and CRUD6 test config
          cp ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-paths.php .
          cp ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-paths.json .
          
          # Test all CRUD6 paths
          php test-paths.php integration-test-paths.json
      
      # ========================================================================
      # Capture CRUD6 Screenshots
      # ========================================================================
      - name: Capture CRUD6 screenshots
        run: |
          cd userfrosting
          
          cp ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/take-screenshots-modular.js .
          node take-screenshots-modular.js integration-test-paths.json
      
      # ========================================================================
      # Upload Artifacts
      # ========================================================================
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crud6-screenshots
          path: /tmp/screenshot_*.png
          if-no-files-found: ignore
          retention-days: 30
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crud6-logs
          path: |
            userfrosting/app/logs/*.log
            userfrosting/app/storage/logs/*.log
          if-no-files-found: ignore
          retention-days: 30
      
      # ========================================================================
      # Summary
      # ========================================================================
      - name: Summary
        if: always()
        run: |
          echo "========================================="
          echo "CRUD6 Integration Test Complete"
          echo "========================================="
          echo ""
          echo "‚úÖ CRUD6 framework: Auto-installed"
          echo "‚úÖ CRUD6 + ${{ env.SPRINKLE_DIR }} configured"
          echo "‚úÖ Database migrations completed"
          echo "‚úÖ CRUD6 seeds run and validated"
          echo "‚úÖ Seed idempotency verified"
          echo "‚úÖ CRUD6 API and frontend paths tested"
          echo "‚úÖ CRUD6 screenshots captured"
          echo ""
          echo "üì∏ View artifacts:"
          echo "   - crud6-screenshots: Frontend screenshots"
          echo "   - crud6-logs: PHP error logs"
          echo ""
          echo "‚ÑπÔ∏è  This workflow tests CRUD6 functionality only."
          echo "   Create additional workflows for ${{ env.SPRINKLE_DIR }}-specific features."
          echo ""
          echo "üìö Framework location: .github/crud6-framework/"
          echo "   To use offline, commit this directory to your repository."
