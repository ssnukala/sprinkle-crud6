# Schema-Driven Integration Testing and Seed Data

This directory contains scripts and configurations for dynamically generating integration test paths and seed data from CRUD6 JSON schemas.

## Overview

The CRUD6 sprinkle uses a **schema-driven approach** for integration testing and seed data management:

1. **Dynamic Path Generation**: Integration test paths are automatically generated from schema definitions
2. **SQL-Based Seed Data**: Test data is generated as SQL from schemas instead of PHP seed classes
3. **Protected System Records**: User ID 1 and Group ID 1 are reserved and protected from destructive tests

## Architecture

### Execution Order in Integration Tests

```
1. Run migrations (php bakery migrate)
   ↓
2. Create admin user (php bakery create:admin-user)
   → Creates user_id = 1, group_id = 1
   ↓
3. Load SQL seed data (php load-seed-sql.php)
   → Creates test data starting from ID 100
   ↓
4. Run unauthenticated path tests
   → Tests API/frontend access without authentication
   ↓
5. Run authenticated path tests
   → Tests API/frontend access with valid credentials
```

## Scripts

### 1. generate-paths-from-models.js

Generates integration test path configurations from model definitions.

**Input**: `integration-test-models.json` (model definitions with path templates)  
**Output**: `integration-test-paths.json` (complete test path configuration)

**Usage**:
```bash
node generate-paths-from-models.js \
  .github/config/integration-test-models.json \
  .github/config/integration-test-paths.json
```

**Features**:
- Generates paths for authenticated and unauthenticated scenarios
- Creates both API and frontend test paths
- Supports custom actions and relationships
- Includes validation rules for expected responses

### 2. generate-seed-sql.js

Generates SQL INSERT statements from CRUD6 JSON schemas.

**Input**: Directory containing `*.json` schema files  
**Output**: SQL file with test seed data

**Usage**:
```bash
node generate-seed-sql.js examples/schema app/sql/seeds/crud6-test-data.sql
```

**Features**:
- Automatically generates test data based on field types
- Respects field validation rules (required, unique, length, etc.)
- **Starts all test data from ID 100** (avoids ID 1 conflicts)
- Generates relationship data for many-to-many tables
- Creates idempotent SQL with INSERT...ON DUPLICATE KEY UPDATE
- Safe for re-seeding without duplicates

**Generated Data Examples**:
- String fields: Generates descriptive test values
- Email fields: `test2@example.com`, `test3@example.com`, etc.
- Unique fields: `test_{fieldname}_2`, `test_{fieldname}_3`, etc.
- Boolean fields: Uses schema defaults or `true`
- Date fields: Sequential dates starting from 2024-01-02
- Numeric fields: Sequential values starting from 2

### 3. load-seed-sql.php

Loads generated SQL seed data into the database.

**Input**: SQL file generated by `generate-seed-sql.js`  
**Output**: Database populated with test data

**Usage**:
```bash
php load-seed-sql.php app/sql/seeds/crud6-test-data.sql
```

**Features**:
- Boots UserFrosting application context
- Executes SQL within a transaction
- Continues on duplicate key errors (idempotent)
- Provides detailed progress output

### 4. test-paths.php

Tests API and frontend paths from JSON configuration.

**Input**: `integration-test-paths.json`  
**Output**: Test results with pass/fail status

**Usage**:
```bash
# Test all paths
php test-paths.php integration-test-paths.json

# Test only unauthenticated paths
php test-paths.php integration-test-paths.json unauth

# Test only API paths
php test-paths.php integration-test-paths.json both api
```

## Configuration Files

### integration-test-models.json

Defines models and their test configurations.

**Key Fields**:
- `test_id`: ID to use for single-record tests (MUST be >= 2)
- `safe_test_id_note`: Documentation about ID protection
- `create_payload`: Data for CREATE endpoint tests
- `relationships`: Relationship configurations for nested endpoints
- `custom_actions`: Custom action endpoints to test

**Security Notes Section**:
```json
{
  "security_notes": {
    "reserved_ids": {
      "user_id_1": "Reserved for system admin user - NEVER use in DELETE/DISABLE tests",
      "group_id_1": "Reserved for admin group - NEVER use in DELETE/DISABLE tests"
    },
    "test_data_range": "All test IDs start from 2 to avoid conflicts with system records",
    "safe_operations": "DELETE and DISABLE operations should only target IDs >= 2"
  }
}
```

### integration-test-paths.json

Complete test path configuration (generated from models).

**Structure**:
```json
{
  "paths": {
    "authenticated": {
      "api": { /* API endpoint tests */ },
      "frontend": { /* Frontend page tests */ }
    },
    "unauthenticated": {
      "api": { /* Expected 401 responses */ },
      "frontend": { /* Expected redirects to login */ }
    }
  }
}
```

## Protected System Records

### ⚠️ CRITICAL: User ID 1 and Group ID 1

These IDs are **RESERVED** for system administration and MUST NOT be used in destructive tests:

- **User ID 1**: Admin user created by `bakery create:admin-user`
- **Group ID 1**: Admin group (typically "terran" or site admin group)

### Test Data Range

- All test data starts from **ID 100 or higher**
- DELETE operations MUST only target IDs >= 2
- DISABLE operations MUST only target IDs >= 2
- UPDATE operations on ID 1 should be avoided in tests

### Implementation

The `integration-test-models.json` enforces this by:
- Setting `test_id: 2` for all models
- Including `safe_test_id_note` documentation
- Documenting the constraint in `security_notes`

## Migration from PHP Seed Classes

### Old Approach (Deprecated)
```php
// app/src/Database/Seeds/DefaultRoles.php
class DefaultRoles implements SeedInterface {
    public function run(): void {
        // PHP code to create roles
    }
}
```

### New Approach (Current)
```sql
-- Generated from schema: roles.json
INSERT INTO roles (slug, name, description)
VALUES ('test-role-2', 'Test Role 2', 'Test description')
ON DUPLICATE KEY UPDATE slug = VALUES(slug);
```

### Benefits of SQL Approach

1. **Schema-Driven**: Automatically generated from JSON schemas
2. **Idempotent**: Safe to run multiple times without duplicates
3. **Transparent**: Easy to review and understand what data is created
4. **Fast**: Direct SQL is faster than ORM operations
5. **Portable**: SQL can be used in different test environments
6. **Verifiable**: Easy to validate generated data

### Migration Steps

When converting from PHP seeders to SQL:

1. Ensure schema files are complete and accurate
2. Run `generate-seed-sql.js` to create SQL file
3. Review generated SQL for correctness
4. Test SQL loading with `load-seed-sql.php`
5. Update CI/CD workflows to use SQL instead of PHP seeders
6. Deprecate (but don't delete) old PHP seeder classes

## Workflow Integration

### GitHub Actions Workflow

```yaml
# .github/workflows/integration-test.yml

- name: Run migrations
  run: php bakery migrate --force

- name: Create admin user
  run: |
    php bakery create:admin-user \
      --username=admin \
      --password=admin123 \
      --email=admin@example.com

- name: Generate and load seed data
  run: |
    # Generate SQL from schemas
    node .github/scripts/generate-seed-sql.js \
      examples/schema \
      app/sql/seeds/crud6-test-data.sql
    
    # Load SQL into database
    php .github/scripts/load-seed-sql.php \
      app/sql/seeds/crud6-test-data.sql

- name: Test unauthenticated paths
  run: php test-paths.php integration-test-paths.json unauth

- name: Test authenticated paths
  run: php test-paths.php integration-test-paths.json auth
```

## Testing

### Verify Dynamic Path Generation

```bash
# Generate paths from models
node .github/scripts/generate-paths-from-models.js \
  .github/config/integration-test-models.json \
  /tmp/test-paths.json

# Check output
cat /tmp/test-paths.json | jq '.paths.authenticated.api | keys'
cat /tmp/test-paths.json | jq '.paths.unauthenticated.api | keys'
```

### Verify SQL Seed Generation

```bash
# Generate SQL from schemas
node .github/scripts/generate-seed-sql.js \
  examples/schema \
  /tmp/test-seed.sql

# Check that IDs start from 2
grep "VALUES" /tmp/test-seed.sql | head -20

# Check for protected IDs (should not appear in test data)
grep -i "user_id.*1[^0-9]" /tmp/test-seed.sql || echo "✅ No user_id=1 found"
grep -i "group_id.*1[^0-9]" /tmp/test-seed.sql || echo "✅ No group_id=1 found"
```

### Verify ID Protection

```bash
# Check integration test models config
jq '.models.users.test_id' .github/config/integration-test-models.json
# Should output: 2

jq '.models.groups.test_id' .github/config/integration-test-models.json
# Should output: 2
```

## Troubleshooting

### Issue: Duplicate Key Errors

**Symptom**: SQL loading fails with duplicate key errors  
**Solution**: This is expected and handled by ON DUPLICATE KEY UPDATE. The script will continue and report warnings, not failures.

### Issue: Test Failing with 404 on ID 1

**Symptom**: Tests fail when trying to access records with ID 1  
**Solution**: Update `integration-test-models.json` to use `test_id: 2` instead of `test_id: 1`

### Issue: User/Group Not Found

**Symptom**: Tests fail because expected user/group doesn't exist  
**Solution**: Ensure admin user is created BEFORE loading SQL seed data

## Best Practices

1. **Always use test_id >= 2** in model configurations
2. **Never hardcode ID 1** in destructive test operations
3. **Document ID constraints** in schema files when relevant
4. **Regenerate SQL** after schema changes
5. **Review generated SQL** before committing to repository
6. **Keep schemas up-to-date** with actual database structure

## Future Enhancements

- [ ] Add support for custom seed data generators per field type
- [ ] Generate seed data based on real-world patterns (faker integration)
- [ ] Add seed data validation against schema constraints
- [ ] Support for multiple test data sets (minimal, standard, comprehensive)
- [ ] Automatic detection of required relationships and dependencies
- [ ] Generate test data for file uploads and binary fields

## References

- UserFrosting 6 Documentation: https://learn.userfrosting.com/
- CRUD6 Schema Format: See `examples/schema/README.md`
- Integration Test Guide: See `INTEGRATION_TESTING.md`
