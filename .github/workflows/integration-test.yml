name: sprinkle-crud6 Integration Test

# AUTO-GENERATED from integration-test-config.json
# To regenerate: node .github/testing-framework/scripts/generate-workflow.js

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  SPRINKLE_DIR: sprinkle-crud6
  COMPOSER_PACKAGE: ssnukala/sprinkle-crud6
  NPM_PACKAGE: "@ssnukala/sprinkle-crud6"
  SCHEMA_PATH: "examples/schema"
  FRAMEWORK_REPO: ssnukala/sprinkle-crud6
  FRAMEWORK_BRANCH: main
  UF_VERSION: "^6.0-beta"
  PHP_VERSION: "8.1"
  NODE_VERSION: "20"

jobs:
  integration-test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: userfrosting_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - name: Checkout sprinkle
        uses: actions/checkout@v4
        with:
          path: ${{ env.SPRINKLE_DIR }}
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, gd, pdo_mysql
          coverage: none
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install testing framework
        run: |
          cd ${{ env.SPRINKLE_DIR }}
          
          # Check if framework already exists (either as crud6-framework or testing-framework)
          if [ -d ".github/crud6-framework" ]; then
            echo "‚úÖ Using local framework (crud6-framework)"
          elif [ -d ".github/testing-framework" ]; then
            echo "‚úÖ Using local framework (testing-framework)"
            # Copy to crud6-framework for consistency (copy vs symlink to allow independent modifications)
            cp -r .github/testing-framework .github/crud6-framework
            chmod +x .github/crud6-framework/scripts/*.php
            echo "‚úÖ Framework copied to crud6-framework"
          else
            echo "üì¶ Installing framework..."
            git clone --depth 1 --branch ${{ env.FRAMEWORK_BRANCH }} \
              https://github.com/${{ env.FRAMEWORK_REPO }}.git /tmp/crud6-repo
            mkdir -p .github/crud6-framework
            cp -r /tmp/crud6-repo/.github/testing-framework/* .github/crud6-framework/
            chmod +x .github/crud6-framework/scripts/*.php
            echo "‚úÖ Framework installed"
          fi
          
          mkdir -p .github/config
          if [ -d "/tmp/crud6-repo/.github/config" ]; then
            cp /tmp/crud6-repo/.github/config/integration-test-*.json .github/config/ 2>/dev/null || true
          fi
      
      - name: Create UserFrosting project
        run: |
          composer create-project userfrosting/userfrosting userfrosting "${{ env.UF_VERSION }}" \
            --no-scripts --no-install --ignore-platform-reqs
          
          cd userfrosting/app
          mkdir -p storage/sessions storage/cache storage/logs logs cache sessions
          chmod -R 777 storage sessions logs cache
          touch logs/userfrosting.log
      
      - name: Configure Composer dependencies
        run: |
          cd userfrosting
          
          if [ -d "/tmp/crud6-repo" ]; then
            composer config repositories.crud6 path /tmp/crud6-repo
            composer require ssnukala/sprinkle-crud6:@dev --no-update
          fi
          
          composer config repositories.local path ../${{ env.SPRINKLE_DIR }}
          composer require ${{ env.COMPOSER_PACKAGE }}:@dev --no-update
          
          composer config minimum-stability beta
          composer config prefer-stable true
          
          composer install --no-interaction --prefer-dist
      
      - name: Configure NPM dependencies
        run: |
          cd userfrosting
          npm update
          
          if [ -d "/tmp/crud6-repo" ]; then
            cd /tmp/crud6-repo
            npm pack
            mv ssnukala-sprinkle-crud6-*.tgz "$GITHUB_WORKSPACE/userfrosting/"
            cd "$GITHUB_WORKSPACE/userfrosting"
            npm install ./ssnukala-sprinkle-crud6-*.tgz
          fi
          
          cd "$GITHUB_WORKSPACE/${{ env.SPRINKLE_DIR }}"
          npm pack 2>/dev/null || true
          if ls *.tgz 1> /dev/null 2>&1; then
            mv *.tgz "$GITHUB_WORKSPACE/userfrosting/"
            cd "$GITHUB_WORKSPACE/userfrosting"
            npm install ./*.tgz 2>/dev/null || echo "NPM package optional"
          fi
      
      - name: Configure MyApp.php
        run: |
          cd userfrosting
          
          sed -i '/use UserFrosting\\Sprinkle\\Core\\Core;/a use UserFrosting\\Sprinkle\\CRUD6\\CRUD6;' app/src/MyApp.php
          sed -i '/Admin::class,/a \            CRUD6::class,' app/src/MyApp.php
          
          echo ""
          echo "‚úÖ MyApp.php configured"
          echo "Updated app/src/MyApp.php:"
          cat app/src/MyApp.php
      
      - name: Configure main.ts
        run: |
          cd userfrosting
          
          sed -i "/import AdminSprinkle from '@userfrosting\\/sprinkle-admin'/a import CRUD6Sprinkle from '@ssnukala\\/sprinkle-crud6'" app/assets/main.ts
          sed -i "/app.use(AdminSprinkle)/a app.use(CRUD6Sprinkle)" app/assets/main.ts
          
          echo ""
          echo "‚úÖ main.ts configured"
          echo "Updated app/assets/main.ts:"
          cat app/assets/main.ts
      
      - name: Configure routes (simple pattern)
        run: |
          cd userfrosting
          
          # Simple array spread pattern
          sed -i "/import AdminRoutes from '@userfrosting\\/sprinkle-admin\\/routes'/a import CRUD6Routes from '@ssnukala/sprinkle-crud6/routes'" app/assets/router/index.ts
          sed -i "/\\.\\.\\.AccountRoutes,/a \\            ...CRUD6Routes," app/assets/router/index.ts

          echo ""
          echo "‚úÖ Routes configured (simple pattern)"
          echo "Updated app/assets/router/index.ts:"
          cat app/assets/router/index.ts

      
      - name: Verify NPM package installation
        run: |
          cd userfrosting
          # Verify the package is installed correctly
          npm list ${{ env.NPM_PACKAGE }} || echo "Package installed as local dependency"
          # Check that the package files are accessible
          test -f node_modules/${{ env.NPM_PACKAGE }}/app/assets/index.ts && echo "‚úÖ NPM package files accessible" || echo "‚ö†Ô∏è NPM package files not found"

      - name: Configure vite.config.ts for CommonJS dependencies
        run: |
          cd userfrosting
          # Configure vite.config.ts to handle CommonJS dependencies (limax and lodash.deburr)
          # sprinkle-crud6 uses limax which depends on lodash.deburr (CommonJS modules)
          # These need to be pre-bundled by Vite to work properly

          # Check if already configured
          if grep -q "'limax'" vite.config.ts || grep -q '"limax"' vite.config.ts; then
            echo "limax already in vite.config.ts, skipping configuration"
          elif grep -q "optimizeDeps:" vite.config.ts; then
            echo "optimizeDeps section exists, checking for include array..."
            if grep -q "include:" vite.config.ts; then
              echo "include array exists, adding limax and lodash.deburr to it..."
              # Add to existing include array using awk (handles both single-line and multi-line)
              awk '
                /include: \[/ {
                  if (/\]/) {
                    # Single-line array: include: [...]
                    sub(/\]/, ", '\''limax'\'', '\''lodash.deburr'\'']");
                    print;
                    next;
                  } else {
                    # Multi-line array start
                    print;
                    in_array=1;
                    next;
                  }
                }
                in_array {
                  if (/\]/) {
                    # Multi-line array end - add items before closing bracket
                    print "            '\''limax'\'',";
                    print "            '\''lodash.deburr'\''";
                    print $0;
                    in_array=0;
                    next;
                  } else {
                    # Inside array - ensure trailing comma
                    if (!/,$/) {
                      sub(/$/, ",");
                    }
                    print;
                    next;
                  }
                }
                {print}
              ' vite.config.ts > vite.config.ts.tmp && mv vite.config.ts.tmp vite.config.ts
            else
              echo "include array doesn't exist, creating it..."
              # Add include array to optimizeDeps
              sed -i "/optimizeDeps: {/a \\        include: ['limax', 'lodash.deburr']," vite.config.ts
            fi
          else
            echo "optimizeDeps section doesn't exist, creating it..."
            # Add optimizeDeps section after plugins block
            # This handles both single-line (plugins: [...],) and multi-line plugins arrays
            awk '
              /plugins:/ {in_plugins=1} 
              in_plugins && /\],/ {
                print;
                print "    optimizeDeps: {";
                print "        // Include CommonJS dependencies for sprinkle-crud6";
                print "        // limax uses lodash.deburr which is a CommonJS module";
                print "        include: ['\''limax'\'', '\''lodash.deburr'\'']";
                print "    },";
                in_plugins=0;
                next;
              } 
              {print}
            ' vite.config.ts > vite.config.ts.tmp && mv vite.config.ts.tmp vite.config.ts
          fi

          echo ""
          echo "‚úÖ Vite configuration updated for CommonJS dependencies"
          echo "Updated vite.config.ts:"
          cat vite.config.ts

      
      - name: Setup environment
        run: |
          cd userfrosting
          cp app/.env.example app/.env
          sed -i 's/DB_CONNECTION=.*/DB_CONNECTION="mysql"/' app/.env
          sed -i 's/DB_HOST=.*/DB_HOST="127.0.0.1"/' app/.env
          sed -i 's/DB_PORT=.*/DB_PORT="3306"/' app/.env
          sed -i 's/DB_NAME=.*/DB_NAME="userfrosting_test"/' app/.env
          sed -i 's/DB_USER=.*/DB_USER="root"/' app/.env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD="root"/' app/.env
          echo "BAKERY_CONFIRM_SENSITIVE_COMMAND=false" >> app/.env
          echo "TEST_SESSION_HANDLER=database" >> app/.env
      
      - name: Run migrations
        run: |
          cd userfrosting
          php bakery migrate --force
      
      - name: Generate and create tables from schemas
        run: |
          cd userfrosting
          
          SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/${{ env.SCHEMA_PATH }}"
          if [ -z "${{ env.SCHEMA_PATH }}" ]; then
            SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/app/schema/crud6"
          fi
          
          if [ ! -d "$SCHEMA_DIR" ]; then
            echo "‚ùå ERROR: Schema directory not found: $SCHEMA_DIR"
            exit 1
          fi
          
          echo "‚úÖ Using schemas from: $SCHEMA_DIR"
          
          # Generate DDL (CREATE TABLE statements) from schemas
          node ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/generate-ddl-sql.js \
            "$SCHEMA_DIR" tables.sql
          
          # Create tables from DDL
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/load-seed-sql.php \
            tables.sql
          
          echo "‚úÖ Tables created from schemas"
      
      - name: Generate and load SQL seed data
        run: |
          cd userfrosting
          
          SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/${{ env.SCHEMA_PATH }}"
          if [ -z "${{ env.SCHEMA_PATH }}" ]; then
            SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/app/schema/crud6"
          fi
          
          # Generate seed data
          node ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/generate-seed-sql.js \
            "$SCHEMA_DIR" seed-data.sql
          
          # Load seed data
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/load-seed-sql.php \
            seed-data.sql
          
          echo "‚úÖ Schema-driven SQL loaded"

      - name: Run PHP seeds
        run: |
          cd userfrosting
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/run-seeds.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-seeds.json
      
      - name: Validate seed data
        run: |
          cd userfrosting
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/check-seeds-modular.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-seeds.json
      
      - name: Test seed idempotency
        run: |
          cd userfrosting
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-seed-idempotency-modular.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-seeds.json

      - name: Build frontend assets
        run: |
          cd userfrosting
          # UserFrosting 6 uses bakery bake to build assets via Vite
          # Note: Even though we bake, we still need vite dev server for proper asset serving
          php bakery bake || echo "‚ö†Ô∏è Build failed but continuing with tests"
      
      - name: Start PHP development server
        run: |
          cd userfrosting
          # Start PHP server using bakery serve in background
          php bakery serve &
          SERVER_PID=$!
          echo $SERVER_PID > /tmp/server.pid
          sleep 10

          # Test if server is running
          curl -f http://localhost:8080 || (echo "‚ö†Ô∏è Server may not be ready yet" && sleep 5 && curl -f http://localhost:8080)
          echo "‚úÖ PHP server started on localhost:8080"

      - name: Start Vite development server
        run: |
          cd userfrosting
          # Use npm update to fix any package issues
          npm update
          # Start Vite server in background using bakery command (follows UF6 standards)
          php bakery assets:vite &
          VITE_PID=$!
          echo $VITE_PID > /tmp/vite.pid

          # Wait longer for Vite to fully start up
          echo "Waiting for Vite server to start..."
          sleep 20

          # Try to verify Vite is running by checking if the page loads properly
          echo "Testing if frontend is accessible..."
          curl -f http://localhost:8080 || echo "‚ö†Ô∏è  Page load test after Vite start"

          echo "‚úÖ Vite server started"

      - name: Test unauthenticated API paths
        run: |
          cd userfrosting
          echo "========================================="
          echo "Testing Unauthenticated API Paths"
          echo "========================================="
          echo "Testing that protected API resources return 401/403 for unauthenticated users"
          echo ""
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-paths.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-paths.json \
            unauth api > /tmp/test-results-unauth-api.txt 2>&1
          cat /tmp/test-results-unauth-api.txt
      
      - name: Test unauthenticated frontend paths
        run: |
          cd userfrosting
          echo "========================================="
          echo "Testing Unauthenticated Frontend Paths"
          echo "========================================="
          echo "Testing that protected frontend pages redirect to login for unauthenticated users"
          echo ""
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-paths.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-paths.json \
            unauth frontend > /tmp/test-results-unauth-frontend.txt 2>&1
          cat /tmp/test-results-unauth-frontend.txt
      
      - name: Install Playwright
        run: |
          cd userfrosting
          npm install playwright
          npx playwright install chromium
      
      - name: Copy testing scripts to userfrosting
        run: |
          cd userfrosting
          # Copy scripts to userfrosting so they can access node_modules
          cp ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/login-admin.js .
          cp ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/take-screenshots-modular.js .
          echo "‚úÖ Testing scripts copied to userfrosting directory"
      
      - name: Login as admin user
        run: |
          cd userfrosting
          # Run from userfrosting directory where node_modules/playwright is installed
          node login-admin.js \
            http://localhost:8080 \
            admin \
            admin123 \
            /tmp/admin-auth-state.json
      
      - name: Test authenticated API paths
        run: |
          cd userfrosting
          echo "========================================="
          echo "Testing Authenticated API Paths"
          echo "========================================="
          echo "Using authenticated session from previous login step"
          echo "Testing API endpoints with admin credentials"
          echo "Expected: All API endpoints return 200 with valid data"
          echo ""
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-paths.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-paths.json \
            auth api > /tmp/test-results-auth-api.txt 2>&1
          cat /tmp/test-results-auth-api.txt
      
      - name: Test authenticated frontend paths
        run: |
          cd userfrosting
          echo "========================================="
          echo "Testing Authenticated Frontend Paths"
          echo "========================================="
          echo "Using authenticated session from previous login step"
          echo "Testing frontend pages with admin credentials"
          echo "Expected: All frontend pages load successfully (200)"
          echo ""
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-paths.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-paths.json \
            auth frontend > /tmp/test-results-auth-frontend.txt 2>&1
          cat /tmp/test-results-auth-frontend.txt
      
      - name: Generate test summary table
        if: always()
        run: |
          cd userfrosting
          echo ""
          echo "========================================="
          echo "INTEGRATION TEST RESULTS SUMMARY"
          echo "========================================="
          echo ""
          
          # Create summary table
          cat << 'EOF' > /tmp/test-summary.txt
          | Test Category | Auth Status | Type | Status | Details |
          |---------------|-------------|------|--------|---------|
          EOF
          
          # Function to extract summary from test results
          extract_summary() {
            local file=$1
            local auth_status=$2
            local type=$3
            
            if [ -f "$file" ]; then
              # Extract test counts
              local total=$(grep "Total tests:" "$file" | awk '{print $3}' || echo "0")
              local passed=$(grep "Passed:" "$file" | awk '{print $2}' || echo "0")
              local warnings=$(grep "Warnings:" "$file" | awk '{print $2}' || echo "0")
              local failed=$(grep "Failed:" "$file" | awk '{print $2}' || echo "0")
              
              # Determine status
              local status="‚úÖ PASS"
              if [ "$failed" -gt 0 ]; then
                status="‚ùå FAIL"
              elif [ "$warnings" -gt 0 ]; then
                status="‚ö†Ô∏è  WARN"
              fi
              
              # Format details
              local details="Total: $total, Passed: $passed, Warnings: $warnings, Failed: $failed"
              
              echo "| Step $step | $auth_status | $type | $status | $details |" >> /tmp/test-summary.txt
              step=$((step + 1))
            else
              echo "| Step $step | $auth_status | $type | ‚ùå ERROR | Test file not found |" >> /tmp/test-summary.txt
              step=$((step + 1))
            fi
          }
          
          # Initialize step counter
          step=1
          
          # Extract summaries for all test runs
          extract_summary "/tmp/test-results-unauth-api.txt" "Unauthenticated" "API"
          extract_summary "/tmp/test-results-unauth-frontend.txt" "Unauthenticated" "Frontend"
          extract_summary "/tmp/test-results-auth-api.txt" "Authenticated" "API"
          extract_summary "/tmp/test-results-auth-frontend.txt" "Authenticated" "Frontend"
          
          # Display the summary table
          cat /tmp/test-summary.txt
          echo ""
          
          # Overall summary
          echo "========================================="
          echo "OVERALL TEST SUMMARY"
          echo "========================================="
          
          total_tests=0
          total_passed=0
          total_warnings=0
          total_failed=0
          
          for file in /tmp/test-results-*.txt; do
            if [ -f "$file" ]; then
              tests=$(grep "Total tests:" "$file" | awk '{print $3}' || echo "0")
              passed=$(grep "Passed:" "$file" | awk '{print $2}' || echo "0")
              warnings=$(grep "Warnings:" "$file" | awk '{print $2}' || echo "0")
              failed=$(grep "Failed:" "$file" | awk '{print $2}' || echo "0")
              
              total_tests=$((total_tests + tests))
              total_passed=$((total_passed + passed))
              total_warnings=$((total_warnings + warnings))
              total_failed=$((total_failed + failed))
            fi
          done
          
          echo "Total Tests Executed: $total_tests"
          echo "‚úÖ Passed: $total_passed"
          echo "‚ö†Ô∏è  Warnings: $total_warnings (expected for unauthenticated access control)"
          echo "‚ùå Failed: $total_failed"
          echo ""
          
          if [ "$total_failed" -gt 0 ]; then
            echo "‚ùå RESULT: Some tests failed - review logs above"
            exit 1
          elif [ "$total_warnings" -gt 0 ]; then
            echo "‚úÖ RESULT: All tests passed (warnings are expected for access control)"
          else
            echo "‚úÖ RESULT: All tests passed"
          fi

      - name: Capture screenshots
        run: |
          cd userfrosting
          # Run from userfrosting directory where node_modules/playwright is installed
          node take-screenshots-modular.js \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-paths.json \
            screenshots

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-screenshots
          path: userfrosting/screenshots/
          retention-days: 7
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: userfrosting/app/logs/
          retention-days: 7
      
      - name: Stop servers
        if: always()
        run: |
          if [ -f /tmp/server.pid ]; then
            kill $(cat /tmp/server.pid) || true
          fi
          if [ -f /tmp/vite.pid ]; then
            kill $(cat /tmp/vite.pid) || true
          fi
