name: sprinkle-crud6 Integration Test

# AUTO-GENERATED from integration-test-config.json
# To regenerate: node .github/testing-framework/scripts/generate-workflow.js

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  SPRINKLE_DIR: sprinkle-crud6
  COMPOSER_PACKAGE: ssnukala/sprinkle-crud6
  NPM_PACKAGE: "@ssnukala/sprinkle-crud6"
  SCHEMA_PATH: "examples/schema"
  FRAMEWORK_REPO: ssnukala/sprinkle-crud6
  FRAMEWORK_BRANCH: main
  UF_VERSION: "^6.0-beta"
  PHP_VERSION: "8.1"
  NODE_VERSION: "20"

jobs:
  integration-test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: userfrosting_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - name: Checkout sprinkle
        uses: actions/checkout@v4
        with:
          path: ${{ env.SPRINKLE_DIR }}
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, gd, pdo_mysql
          coverage: none
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install testing framework
        run: |
          cd ${{ env.SPRINKLE_DIR }}
          
          if [ -d ".github/crud6-framework" ]; then
            echo "‚úÖ Using local framework"
          else
            echo "üì¶ Installing framework..."
            git clone --depth 1 --branch ${{ env.FRAMEWORK_BRANCH }} \
              https://github.com/${{ env.FRAMEWORK_REPO }}.git /tmp/crud6-repo
            mkdir -p .github/crud6-framework
            cp -r /tmp/crud6-repo/.github/testing-framework/* .github/crud6-framework/
            chmod +x .github/crud6-framework/scripts/*.php
            echo "‚úÖ Framework installed"
          fi
          
          mkdir -p .github/config
          if [ -d "/tmp/crud6-repo/.github/config" ]; then
            cp /tmp/crud6-repo/.github/config/integration-test-*.json .github/config/ 2>/dev/null || true
          fi
      
      - name: Create UserFrosting project
        run: |
          composer create-project userfrosting/userfrosting userfrosting "${{ env.UF_VERSION }}" \
            --no-scripts --no-install --ignore-platform-reqs
          
          cd userfrosting/app
          mkdir -p storage/sessions storage/cache storage/logs logs cache sessions
          chmod -R 777 storage sessions logs cache
          touch logs/userfrosting.log
      
      - name: Configure Composer dependencies
        run: |
          cd userfrosting
          
          if [ -d "/tmp/crud6-repo" ]; then
            composer config repositories.crud6 path /tmp/crud6-repo
            composer require ssnukala/sprinkle-crud6:@dev --no-update
          fi
          
          composer config repositories.local path ../${{ env.SPRINKLE_DIR }}
          composer require ${{ env.COMPOSER_PACKAGE }}:@dev --no-update
          
          composer config minimum-stability beta
          composer config prefer-stable true
          
          composer install --no-interaction --prefer-dist
      
      - name: Configure NPM dependencies
        run: |
          cd userfrosting
          npm update
          
          if [ -d "/tmp/crud6-repo" ]; then
            cd /tmp/crud6-repo
            npm pack
            mv ssnukala-sprinkle-crud6-*.tgz "$GITHUB_WORKSPACE/userfrosting/"
            cd "$GITHUB_WORKSPACE/userfrosting"
            npm install ./ssnukala-sprinkle-crud6-*.tgz
          fi
          
          cd "$GITHUB_WORKSPACE/${{ env.SPRINKLE_DIR }}"
          npm pack 2>/dev/null || true
          if ls *.tgz 1> /dev/null 2>&1; then
            mv *.tgz "$GITHUB_WORKSPACE/userfrosting/"
            cd "$GITHUB_WORKSPACE/userfrosting"
            npm install ./*.tgz 2>/dev/null || echo "NPM package optional"
          fi
      
      - name: Configure MyApp.php
        run: |
          cd userfrosting
          
          sed -i '/use UserFrosting\\Sprinkle\\Core\\Core;/a use UserFrosting\\Sprinkle\\CRUD6\\CRUD6;' app/src/MyApp.php
          sed -i '/Admin::class,/a \            CRUD6::class,' app/src/MyApp.php
      
      - name: Configure main.ts
        run: |
          cd userfrosting
          
          sed -i "/import AdminSprinkle from '@userfrosting\\/sprinkle-admin'/a import CRUD6Sprinkle from '@ssnukala\\/sprinkle-crud6'" app/assets/main.ts
          sed -i "/app.use(AdminSprinkle)/a app.use(CRUD6Sprinkle)" app/assets/main.ts
      
      - name: Configure routes (simple pattern)
        run: |
          cd userfrosting
          
          # Simple array spread pattern
          sed -i "/import AdminRoutes from '@userfrosting\\/sprinkle-admin\\/routes'/a import CRUD6Routes from '@ssnukala/sprinkle-crud6/routes'" app/assets/router/index.ts
          sed -i '/\\.\\.\\.AccountRoutes,/a \\            ...CRUD6Routes,' app/assets/router/index.ts

      
      - name: Configure vite.config.ts for CommonJS dependencies
        run: |
          cd userfrosting
          # Configure vite.config.ts to handle CommonJS dependencies (limax and lodash.deburr)
          # sprinkle-crud6 uses limax which depends on lodash.deburr (CommonJS modules)
          # These need to be pre-bundled by Vite to work properly

          # Check if already configured
          if grep -q "'limax'" vite.config.ts || grep -q '"limax"' vite.config.ts; then
            echo "limax already in vite.config.ts, skipping configuration"
          elif grep -q "optimizeDeps:" vite.config.ts; then
            echo "optimizeDeps section exists, checking for include array..."
            if grep -q "include:" vite.config.ts; then
              echo "include array exists, adding limax and lodash.deburr to it..."
              # Add to existing include array using awk (handles both single-line and multi-line)
              awk '
                /include: \[/ {
                  if (/\]/) {
                    # Single-line array: include: [...]
                    sub(/\]/, ", '\''limax'\'', '\''lodash.deburr'\'']");
                    print;
                    next;
                  } else {
                    # Multi-line array start
                    print;
                    in_array=1;
                    next;
                  }
                }
                in_array {
                  if (/\]/) {
                    # Multi-line array end - add items before closing bracket
                    print "            '\''limax'\'',";
                    print "            '\''lodash.deburr'\''";
                    print $0;
                    in_array=0;
                    next;
                  } else {
                    # Inside array - ensure trailing comma
                    if (!/,$/) {
                      sub(/$/, ",");
                    }
                    print;
                    next;
                  }
                }
                {print}
              ' vite.config.ts > vite.config.ts.tmp && mv vite.config.ts.tmp vite.config.ts
            else
              echo "include array doesn't exist, creating it..."
              # Add include array to optimizeDeps
              sed -i "/optimizeDeps: {/a \        include: ['limax', 'lodash.deburr']," vite.config.ts
            fi
          else
            echo "optimizeDeps section doesn't exist, creating it..."
            # Add optimizeDeps section after plugins block
            # This handles both single-line (plugins: [...],) and multi-line plugins arrays
            awk '
              /plugins:/ {in_plugins=1} 
              in_plugins && /\],/ {
                print;
                print "    optimizeDeps: {";
                print "        // Include CommonJS dependencies for sprinkle-crud6";
                print "        // limax uses lodash.deburr which is a CommonJS module";
                print "        include: ['\''limax'\'', '\''lodash.deburr'\'']";
                print "    },";
                in_plugins=0;
                next;
              } 
              {print}
            ' vite.config.ts > vite.config.ts.tmp && mv vite.config.ts.tmp vite.config.ts
          fi

          echo ""
          echo "‚úÖ Vite configuration updated for CommonJS dependencies"
          echo "Updated vite.config.ts:"
          cat vite.config.ts

      
      - name: Setup environment
        run: |
          cd userfrosting
          cp app/.env.example app/.env
          sed -i 's/DB_CONNECTION=.*/DB_CONNECTION="mysql"/' app/.env
          sed -i 's/DB_HOST=.*/DB_HOST="127.0.0.1"/' app/.env
          sed -i 's/DB_PORT=.*/DB_PORT="3306"/' app/.env
          sed -i 's/DB_NAME=.*/DB_NAME="userfrosting_test"/' app/.env
          sed -i 's/DB_USER=.*/DB_USER="root"/' app/.env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD="root"/' app/.env
          echo "BAKERY_CONFIRM_SENSITIVE_COMMAND=false" >> app/.env
          echo "TEST_SESSION_HANDLER=database" >> app/.env
      
      - name: Run migrations
        run: |
          cd userfrosting
          php bakery migrate --force
      
      - name: Run PHP seeds (UserFrosting default seeds)
        run: |
          cd userfrosting
          # Run UserFrosting default seeds (roles, groups, permissions, etc.)
          # These create the infrastructure but DO NOT create users
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/run-seeds.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-seeds.json
          echo "‚úÖ UserFrosting default seeds loaded (roles, groups, permissions)"

      - name: Create admin user (AFTER infrastructure, BEFORE test data)
        run: |
          cd userfrosting
          # Create admin user AFTER default seeds (needs roles/groups/permissions)
          # but BEFORE SQL test data (which expects user ID 1 to exist)
          php bakery create:admin-user \
            --username=admin \
            --password=admin123 \
            --email=admin@example.com \
            --firstName=Admin \
            --lastName=User
          echo "‚úÖ Admin user created (ID 1 reserved for admin)"

      - name: Display roles and permissions BEFORE SQL seeding
        run: |
          cd userfrosting
          echo "========================================="
          echo "DIAGNOSTIC: Checking database state BEFORE SQL generation"
          echo "========================================="
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/display-roles-permissions.php

      - name: Generate and load DDL (CREATE TABLE statements)
        run: |
          cd userfrosting
          
          SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/${{ env.SCHEMA_PATH }}"
          if [ -z "${{ env.SCHEMA_PATH }}" ]; then
            SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/app/schema/crud6"
          fi
          
          if [ ! -d "$SCHEMA_DIR" ]; then
            echo "‚ùå ERROR: Schema directory not found: $SCHEMA_DIR"
            exit 1
          fi
          
          echo "‚úÖ Using schemas from: $SCHEMA_DIR"
          
          # Generate DDL SQL
          node ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/generate-ddl-sql.js \
            "$SCHEMA_DIR" ddl.sql
          
          # Load DDL SQL
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/load-seed-sql.php \
            ddl.sql
          
          echo "‚úÖ DDL loaded - tables created from schemas"
          
          echo "========================================="
          echo "DIAGNOSTIC: Checking database state AFTER DDL loading"
          echo "========================================="
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/display-roles-permissions.php

      - name: Generate and load SQL seed data (test data)
        run: |
          cd userfrosting
          
          SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/${{ env.SCHEMA_PATH }}"
          if [ -z "${{ env.SCHEMA_PATH }}" ]; then
            SCHEMA_DIR="../${{ env.SPRINKLE_DIR }}/app/schema/crud6"
          fi
          
          if [ ! -d "$SCHEMA_DIR" ]; then
            echo "‚ùå ERROR: Schema directory not found: $SCHEMA_DIR"
            exit 1
          fi
          
          echo "‚úÖ Using schemas from: $SCHEMA_DIR"
          
          node ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/generate-seed-sql.js \
            "$SCHEMA_DIR" seed-data.sql
          
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/load-seed-sql.php \
            seed-data.sql
          
          echo "‚úÖ Test data loaded via SQL (IDs start from 100)"
          
          echo "========================================="
          echo "DIAGNOSTIC: Checking database state AFTER seed-data loading"
          echo "========================================="
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/display-roles-permissions.php
      
      - name: Validate seed data
        run: |
          cd userfrosting
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/check-seeds-modular.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-seeds.json
      
      - name: Test seed idempotency
        run: |
          cd userfrosting
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-seed-idempotency-modular.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-seeds.json

      - name: Create test user for modification tests
        run: |
          cd userfrosting
          # Create a second user that can be safely modified/deleted in tests
          # This prevents issues with modifying the logged-in admin user (ID 1)
          php bakery create:user \
            --username=testuser \
            --password=TestPass123 \
            --email=testuser@example.com \
            --firstName=Test \
            --lastName=User
          echo "‚úÖ Test user created (testuser) - will be used for modification/deletion tests"

      - name: Test schema loading
        run: |
          cd userfrosting
          php -r "
          require 'vendor/autoload.php';

          // Test loading all CRUD6 schemas from examples/schema
          \$schemaPath = '../${{ env.SPRINKLE_DIR }}/${{ env.SCHEMA_PATH }}';
          if (!is_dir(\$schemaPath)) {
              echo 'Schema directory not found: ' . \$schemaPath . '\n';
              exit(1);
          }

          \$schemas = glob(\$schemaPath . '/*.json');
          if (empty(\$schemas)) {
              echo 'No schema files found in: ' . \$schemaPath . '\n';
              exit(1);
          }

          foreach (\$schemas as \$schemaFile) {
              \$schemaName = basename(\$schemaFile, '.json');
              \$schema = json_decode(file_get_contents(\$schemaFile), true);
              if (!\$schema) {
                  echo 'Failed to load schema: ' . \$schemaFile . '\n';
                  exit(1);
              }

              echo '‚úÖ Schema loaded: ' . \$schemaName . '\n';
              if (isset(\$schema['model'])) echo '   Model: ' . \$schema['model'] . '\n';
              if (isset(\$schema['table'])) echo '   Table: ' . \$schema['table'] . '\n';
          }

          echo '\n‚úÖ All CRUD6 schemas loaded successfully\n';
          "

      - name: Test database connection
        run: |
          cd userfrosting
          mysql -h 127.0.0.1 -uroot -proot userfrosting_test -e "SELECT * FROM \`groups\` LIMIT 5;"

      - name: Verify runtime directories
        run: |
          cd userfrosting
          
          echo "========================================="
          echo "Verifying Runtime Directories"
          echo "========================================="
          
          # Ensure all runtime directories exist with proper permissions
          mkdir -p app/storage/sessions app/storage/cache app/storage/logs
          mkdir -p app/logs app/cache app/sessions
          chmod -R 777 app/storage app/logs app/cache app/sessions
          
          # Verify directories are writable
          for dir in app/storage/sessions app/storage/cache app/storage/logs app/logs app/cache app/sessions; do
            if [ -w "$dir" ]; then
              echo "‚úÖ $dir is writable"
            else
              echo "‚ùå $dir is NOT writable"
              exit 1
            fi
          done
          
          echo "‚úÖ All runtime directories verified and writable"

      - name: Install Playwright browsers for screenshots
        run: |
          cd userfrosting
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Build frontend assets
        run: |
          cd userfrosting
          # UserFrosting 6 uses bakery bake to build assets via Vite
          # Note: Even though we bake, we still need vite dev server for proper asset serving
          php bakery bake || echo "‚ö†Ô∏è Build failed but continuing with tests"
      
      - name: Start PHP development server
        run: |
          cd userfrosting
          # Start PHP server using bakery serve in background
          php bakery serve &
          SERVER_PID=$!
          echo $SERVER_PID > /tmp/server.pid
          sleep 10
          
          # Test if server is running
          curl -f http://localhost:8080 || (echo "‚ö†Ô∏è Server may not be ready yet" && sleep 5 && curl -f http://localhost:8080)
          echo "‚úÖ PHP server started on localhost:8080"
      
      - name: Start Vite development server
        run: |
          cd userfrosting
          # Use npm update to fix any package issues
          npm update
          # Start Vite server in background using bakery command (follows UF6 standards)
          php bakery assets:vite &
          VITE_PID=$!
          echo $VITE_PID > /tmp/vite.pid
          
          # Wait longer for Vite to fully start up
          echo "Waiting for Vite server to start..."
          sleep 20
          
          # Try to verify Vite is running by checking if the page loads properly
          echo "Testing if frontend is accessible..."
          curl -f http://localhost:8080 || echo "‚ö†Ô∏è Page load test after Vite start"
          
          echo "‚úÖ Vite server started"
      
      - name: Test unauthenticated API paths (with result table)
        run: |
          cd userfrosting
          
          echo "========================================="
          echo "Testing Unauthenticated Paths"
          echo "========================================="
          echo "This step tests unauthenticated endpoints and generates a results table."
          echo "Tests continue even if failures occur to collect all results."
          echo ""
          
          # Set environment variable to continue on failure
          export CONTINUE_ON_FAILURE=true
          
          # Test unauthenticated paths only (both API and frontend)
          php ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/test-paths.php \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-paths.json \
            unauth
          
          echo ""
          echo "========================================="
          echo "‚úÖ Unauthenticated path testing complete"
          echo "========================================="

      - name: Take screenshots and test authenticated API endpoints (with Network Tracking)
        run: |
          cd userfrosting
          
          echo "========================================="
          echo "Screenshots + Network Tracking + API Testing"
          echo "========================================="
          echo "This comprehensive script will:"
          echo "  1. Log in once to establish authenticated session"
          echo "  2. Take screenshots of all frontend pages"
          echo "  3. Test all authenticated API endpoints (reusing the same session)"
          echo "  4. Track all network requests made during page loads"
          echo "  5. Detect error notifications and fail if found"
          echo ""
          
          # Copy the screenshot script to the userfrosting directory where playwright is installed
          # This allows Node.js to resolve the playwright module from local node_modules
          cp ../${{ env.SPRINKLE_DIR }}/.github/crud6-framework/scripts/take-screenshots-with-tracking.js .
          
          # Run the script from the local directory (where playwright is installed)
          node take-screenshots-with-tracking.js \
            ../${{ env.SPRINKLE_DIR }}/.github/config/integration-test-paths.json
          
          echo ""
          echo "========================================="
          echo "Screenshot summary"
          echo "========================================="
          # List screenshots if they exist
          ls -lh /tmp/screenshot_*.png 2>/dev/null || echo "No screenshots generated"
          
          echo ""
          echo "========================================="
          echo "Network Request Summary"
          echo "========================================="
          # Check if network summary file exists and show basic info
          if [ -f /tmp/network-requests-summary.txt ]; then
            echo "‚úÖ Network request summary generated"
            ls -lh /tmp/network-requests-summary.txt
          else
            echo "‚ö†Ô∏è  Network request summary not found"
          fi

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-screenshots
          path: /tmp/screenshot_*.png
          if-no-files-found: warn
          retention-days: 7
      
      - name: Upload network request summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: network-requests-summary
          path: /tmp/network-requests-summary.txt
          if-no-files-found: warn
          retention-days: 7
      
      - name: Upload browser console errors
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: browser-console-errors
          path: /tmp/browser-console-errors.txt
          if-no-files-found: warn
          retention-days: 7
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: userfrosting/app/logs/
          retention-days: 7
      
      - name: Upload SQL files for debugging
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-sql-files
          path: |
            userfrosting/ddl.sql
            userfrosting/seed-data.sql
          retention-days: 7
      
      - name: Stop servers
        if: always()
        run: |
          if [ -f /tmp/server.pid ]; then
            kill $(cat /tmp/server.pid) || true
          fi
          if [ -f /tmp/vite.pid ]; then
            kill $(cat /tmp/vite.pid) || true
          fi
